# Rules: 2731-2751

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | CiscoASA |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Cisco) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (PaloAlto) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (PaloAlto) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (PaloAlto) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | Zscaler |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Zscaler) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | Zscaler |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Zscaler) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | Zscaler |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Zscaler) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | Fortinet |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Fortinet) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | Fortinet |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Fortinet) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | Fortinet |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | CommonSecurityLog (Fortinet) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Office 365|
|DetectionType | Analytics |
|ConnectorId | OfficeATP |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | SecurityAlert (OATP) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | AzureFirewall |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | AzureDiagnostics (Azure Firewall) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | AzureFirewall |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | AzureDiagnostics (Azure Firewall) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1566|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | AzureFirewall |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | AzureDiagnostics (Azure Firewall) |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

## Known PHOSPHORUS group domains/IP - October 2020

'Matches IOCs related to PHOSPHORUS group activity published October 2020 with CommonSecurityLog, DnsEvents, OfficeActivity and VMConnection dataTypes.
References: '

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 7249500f-3038-4b83-8549-9cd8dfa2d498 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/KnownPHOSPHORUSDomainsIP-October2020.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let DomainNames = dynamic(["de-ma.online", "g20saudi.000webhostapp.com", "ksat20.000webhostapp.com"]);
let EmailAddresses = dynamic(["munichconference1962@gmail.com","munichconference@outlook.de", "munichconference@outlook.com", "t20saudiarabia@gmail.com", "t20saudiarabia@hotmail.com", "t20saudiarabia@outlook.sa"]);
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend RequestURLIP = extract(IPRegex, 0, Message)
| where (isnotempty(DNSName) and DNSName has_any (DomainNames)) 
  or (isnotempty(DestinationHostName) and DestinationHostName has_any (DomainNames)) 
  or (isnotempty(RequestURL) and (RequestURL has_any (DomainNames)))
| extend timestamp = TimeGenerated , AccountCustomEntity = SourceUserID, HostCustomEntity = DeviceName
),
(DnsEvents 
| extend DestinationIPAddress = IPAddresses, DNSName = Name, Host = Computer
| where DNSName has_any (DomainNames) 
| extend timestamp = TimeGenerated, IPCustomEntity = DestinationIPAddress, HostCustomEntity = Host),
(VMConnection 
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| where isnotempty(DNSName)
| where DNSName has_any (DomainNames)
| extend timestamp = TimeGenerated , HostCustomEntity = Computer),
(SecurityAlert
| where ProviderName =~ 'OATP'
| extend UPN = case(isnotempty(parse_json(Entities)[0].Upn), parse_json(Entities)[0].Upn, 
                    isnotempty(parse_json(Entities)[1].Upn), parse_json(Entities)[1].Upn,
                    isnotempty(parse_json(Entities)[2].Upn), parse_json(Entities)[2].Upn,
                    isnotempty(parse_json(Entities)[3].Upn), parse_json(Entities)[3].Upn,
                    isnotempty(parse_json(Entities)[4].Upn), parse_json(Entities)[4].Upn,
                    isnotempty(parse_json(Entities)[5].Upn), parse_json(Entities)[5].Upn,
                    isnotempty(parse_json(Entities)[6].Upn), parse_json(Entities)[6].Upn,
                    isnotempty(parse_json(Entities)[7].Upn), parse_json(Entities)[7].Upn,
                    isnotempty(parse_json(Entities)[8].Upn), parse_json(Entities)[8].Upn,
                    parse_json(Entities)[9].Upn)
| where Entities has_any (EmailAddresses)
| extend timestamp = TimeGenerated, AccountCustomEntity = tostring(UPN)),
(AzureDiagnostics
| where ResourceType =~ "AZUREFIREWALLS"
| where msg_s has_any (DomainNames)
| extend timestamp = TimeGenerated))

```

# Rules: 3382-3402

## NOBELIUM - Domain, Hash and IP IOCs - May 2021

'Identifies a match across various data feeds for domains, hashes and IP IOCs related to NOBELIUM.
Ref: https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1204.001|
|Platform | |
|DetectionType | Analytics |
|ConnectorId | GCPDNSDataConnector |
|DetectionId | 677da133-e487-4108-a150-5b926591a92b |
|DataTypes | GCP_DNS_CL |
|QueryFrequency | 6h |
|QueryPeriod | 6h |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | Medium |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NOBELIUM_IOCsMay2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let iocs = externaldata(DateAdded:string,FirstSeen:string,IoC:string,Type:string,TLP:string)
[@"https://raw.githubusercontent.com/microsoft/mstic/master/Indicators/May21-NOBELIUM/May21NOBELIUMIoCs.csv"] with (format="csv", ignoreFirstRecord=True);
let sha256s = (iocs | where Type =~ "SHA256"| project IoC);
let ips = (iocs | where Type =~ "IP"| project IoC);
let IPList = dynamic(["192.99.221.77","83.171.237.173"]);
let ips_list=toscalar(ips | summarize makeset(IoC));
let full_ip_list= array_concat(ips_list, IPList);
let domains = (iocs | where Type =~ "Domain"| project IoC);
let domain_list=toscalar(domains | summarize make_set(IoC));
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let sha256Hashes = dynamic(["2523f94bd4fba4af76f4411fe61084a7e7d80dec163c9ccba9226c80b8b31252",
"d035d394a82ae1e44b25e273f99eae8e2369da828d6b6fdb95076fd3eb5de142",
"94786066a64c0eb260a28a2959fcd31d63d175ade8b05ae682d3f6f9b2a5a916",
"48b5fb3fa3ea67c2bc0086c41ec755c39d748a7100d71b81f618e82bf1c479f0",
"ee44c0692fd2ab2f01d17ca4b58ca6c7f79388cbc681f885bb17ec946514088c",
"ee42ddacbd202008bcc1312e548e1d9ac670dd3d86c999606a3a01d464a2a330"]);
(union isfuzzy=true
(CommonSecurityLog
| where SourceIP in (IPList) or DestinationIP in (IPList) or DestinationHostName in~ (domains) or RequestURL has_any (domains) or Message has_any (IPList)
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend IPMatch = case(SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", MessageIP in (IPList), "Message", RequestURL in (domains), "RequestUrl", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", MessageIP in (IPList), "Message", "NoMatch") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIP, IPMatch == "DestinationIP", DestinationIP, IPMatch == "Message", MessageIP, "NoMatch"), AccountCustomEntity = SourceUserID
),
(_Im_Dns (domain_has_any=todynamic(domain_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(_Im_Dns (response_has_any_prefix=todynamic(full_ip_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(VMConnection
| where SourceIp in (IPList) or DestinationIp in (IPList) or SourceIp in (ips) or DestinationIp in (ips) or RemoteDnsCanonicalNames has_any (domains)
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| extend IPMatch = case( SourceIp in (IPList), "SourceIP", DestinationIp in (IPList), "DestinationIP",  SourceIp in (ips), "SourceIP", DestinationIp in (ips), "DestinationIP", "None") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIp, IPMatch == "DestinationIP", DestinationIp, "NoMatch"), HostCustomEntity = Computer
),
(OfficeActivity
| where ClientIP in (IPList) or ClientIP in (ips)
| extend timestamp = TimeGenerated, IPCustomEntity = ClientIP, AccountCustomEntity = UserId
),
(WindowsFirewall
| where SourceIP in (IPList) or DestinationIP in (IPList) or SourceIP in (ips) or DestinationIP in (ips)
| extend IPMatch = case( SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", "None")
),
(_Im_NetworkSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "SourceIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity = SrcIpAddr //, AccountCustomEntity =User
),
(_Im_NetworkSession(dstipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "DestinationIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity =  DstIpAddr //, AccountCustomEntity =User
),
(_Im_WebSession(url_has_any=domains)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(_Im_WebSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (domains)  
| extend timestamp = TimeGenerated, DNSName = DestinationHost, IPCustomEntity = SourceHost
),
(Event
//This query uses sysmon data depending on table name used this may need updating
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| where EventDetail has_any (sha256Hashes) or EventDetail has_any (sha256s)
| parse EventDetail with * 'SHA256=' SHA256 '",' *
| extend Type = strcat(Type, ": ", Source), Account = UserName, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, FileHash
),
(DeviceFileEvents
| where SHA256 in~ (sha256Hashes) or SHA256 in~ (sha256s)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (sha256Hashes) or TargetFileSHA256 in~ (sha256s)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(CommonSecurityLog
| where FileHash in (sha256Hashes) or FileHash in (sha256s)
| extend timestamp = TimeGenerated
)
)

```

## NOBELIUM - Domain, Hash and IP IOCs - May 2021

'Identifies a match across various data feeds for domains, hashes and IP IOCs related to NOBELIUM.
Ref: https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1204.001|
|Platform | |
|DetectionType | Analytics |
|ConnectorId | NXLogDnsLogs |
|DetectionId | 677da133-e487-4108-a150-5b926591a92b |
|DataTypes | NXLog_DNS_Server_CL |
|QueryFrequency | 6h |
|QueryPeriod | 6h |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | Medium |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NOBELIUM_IOCsMay2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let iocs = externaldata(DateAdded:string,FirstSeen:string,IoC:string,Type:string,TLP:string)
[@"https://raw.githubusercontent.com/microsoft/mstic/master/Indicators/May21-NOBELIUM/May21NOBELIUMIoCs.csv"] with (format="csv", ignoreFirstRecord=True);
let sha256s = (iocs | where Type =~ "SHA256"| project IoC);
let ips = (iocs | where Type =~ "IP"| project IoC);
let IPList = dynamic(["192.99.221.77","83.171.237.173"]);
let ips_list=toscalar(ips | summarize makeset(IoC));
let full_ip_list= array_concat(ips_list, IPList);
let domains = (iocs | where Type =~ "Domain"| project IoC);
let domain_list=toscalar(domains | summarize make_set(IoC));
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let sha256Hashes = dynamic(["2523f94bd4fba4af76f4411fe61084a7e7d80dec163c9ccba9226c80b8b31252",
"d035d394a82ae1e44b25e273f99eae8e2369da828d6b6fdb95076fd3eb5de142",
"94786066a64c0eb260a28a2959fcd31d63d175ade8b05ae682d3f6f9b2a5a916",
"48b5fb3fa3ea67c2bc0086c41ec755c39d748a7100d71b81f618e82bf1c479f0",
"ee44c0692fd2ab2f01d17ca4b58ca6c7f79388cbc681f885bb17ec946514088c",
"ee42ddacbd202008bcc1312e548e1d9ac670dd3d86c999606a3a01d464a2a330"]);
(union isfuzzy=true
(CommonSecurityLog
| where SourceIP in (IPList) or DestinationIP in (IPList) or DestinationHostName in~ (domains) or RequestURL has_any (domains) or Message has_any (IPList)
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend IPMatch = case(SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", MessageIP in (IPList), "Message", RequestURL in (domains), "RequestUrl", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", MessageIP in (IPList), "Message", "NoMatch") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIP, IPMatch == "DestinationIP", DestinationIP, IPMatch == "Message", MessageIP, "NoMatch"), AccountCustomEntity = SourceUserID
),
(_Im_Dns (domain_has_any=todynamic(domain_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(_Im_Dns (response_has_any_prefix=todynamic(full_ip_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(VMConnection
| where SourceIp in (IPList) or DestinationIp in (IPList) or SourceIp in (ips) or DestinationIp in (ips) or RemoteDnsCanonicalNames has_any (domains)
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| extend IPMatch = case( SourceIp in (IPList), "SourceIP", DestinationIp in (IPList), "DestinationIP",  SourceIp in (ips), "SourceIP", DestinationIp in (ips), "DestinationIP", "None") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIp, IPMatch == "DestinationIP", DestinationIp, "NoMatch"), HostCustomEntity = Computer
),
(OfficeActivity
| where ClientIP in (IPList) or ClientIP in (ips)
| extend timestamp = TimeGenerated, IPCustomEntity = ClientIP, AccountCustomEntity = UserId
),
(WindowsFirewall
| where SourceIP in (IPList) or DestinationIP in (IPList) or SourceIP in (ips) or DestinationIP in (ips)
| extend IPMatch = case( SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", "None")
),
(_Im_NetworkSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "SourceIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity = SrcIpAddr //, AccountCustomEntity =User
),
(_Im_NetworkSession(dstipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "DestinationIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity =  DstIpAddr //, AccountCustomEntity =User
),
(_Im_WebSession(url_has_any=domains)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(_Im_WebSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (domains)  
| extend timestamp = TimeGenerated, DNSName = DestinationHost, IPCustomEntity = SourceHost
),
(Event
//This query uses sysmon data depending on table name used this may need updating
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| where EventDetail has_any (sha256Hashes) or EventDetail has_any (sha256s)
| parse EventDetail with * 'SHA256=' SHA256 '",' *
| extend Type = strcat(Type, ": ", Source), Account = UserName, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, FileHash
),
(DeviceFileEvents
| where SHA256 in~ (sha256Hashes) or SHA256 in~ (sha256s)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (sha256Hashes) or TargetFileSHA256 in~ (sha256s)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(CommonSecurityLog
| where FileHash in (sha256Hashes) or FileHash in (sha256s)
| extend timestamp = TimeGenerated
)
)

```

## NOBELIUM - Domain, Hash and IP IOCs - May 2021

'Identifies a match across various data feeds for domains, hashes and IP IOCs related to NOBELIUM.
Ref: https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1204.001|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | CiscoUmbrellaDataConnector |
|DetectionId | 677da133-e487-4108-a150-5b926591a92b |
|DataTypes | Cisco_Umbrella_dns_CL |
|QueryFrequency | 6h |
|QueryPeriod | 6h |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | Medium |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NOBELIUM_IOCsMay2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let iocs = externaldata(DateAdded:string,FirstSeen:string,IoC:string,Type:string,TLP:string)
[@"https://raw.githubusercontent.com/microsoft/mstic/master/Indicators/May21-NOBELIUM/May21NOBELIUMIoCs.csv"] with (format="csv", ignoreFirstRecord=True);
let sha256s = (iocs | where Type =~ "SHA256"| project IoC);
let ips = (iocs | where Type =~ "IP"| project IoC);
let IPList = dynamic(["192.99.221.77","83.171.237.173"]);
let ips_list=toscalar(ips | summarize makeset(IoC));
let full_ip_list= array_concat(ips_list, IPList);
let domains = (iocs | where Type =~ "Domain"| project IoC);
let domain_list=toscalar(domains | summarize make_set(IoC));
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let sha256Hashes = dynamic(["2523f94bd4fba4af76f4411fe61084a7e7d80dec163c9ccba9226c80b8b31252",
"d035d394a82ae1e44b25e273f99eae8e2369da828d6b6fdb95076fd3eb5de142",
"94786066a64c0eb260a28a2959fcd31d63d175ade8b05ae682d3f6f9b2a5a916",
"48b5fb3fa3ea67c2bc0086c41ec755c39d748a7100d71b81f618e82bf1c479f0",
"ee44c0692fd2ab2f01d17ca4b58ca6c7f79388cbc681f885bb17ec946514088c",
"ee42ddacbd202008bcc1312e548e1d9ac670dd3d86c999606a3a01d464a2a330"]);
(union isfuzzy=true
(CommonSecurityLog
| where SourceIP in (IPList) or DestinationIP in (IPList) or DestinationHostName in~ (domains) or RequestURL has_any (domains) or Message has_any (IPList)
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend IPMatch = case(SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", MessageIP in (IPList), "Message", RequestURL in (domains), "RequestUrl", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", MessageIP in (IPList), "Message", "NoMatch") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIP, IPMatch == "DestinationIP", DestinationIP, IPMatch == "Message", MessageIP, "NoMatch"), AccountCustomEntity = SourceUserID
),
(_Im_Dns (domain_has_any=todynamic(domain_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(_Im_Dns (response_has_any_prefix=todynamic(full_ip_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(VMConnection
| where SourceIp in (IPList) or DestinationIp in (IPList) or SourceIp in (ips) or DestinationIp in (ips) or RemoteDnsCanonicalNames has_any (domains)
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| extend IPMatch = case( SourceIp in (IPList), "SourceIP", DestinationIp in (IPList), "DestinationIP",  SourceIp in (ips), "SourceIP", DestinationIp in (ips), "DestinationIP", "None") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIp, IPMatch == "DestinationIP", DestinationIp, "NoMatch"), HostCustomEntity = Computer
),
(OfficeActivity
| where ClientIP in (IPList) or ClientIP in (ips)
| extend timestamp = TimeGenerated, IPCustomEntity = ClientIP, AccountCustomEntity = UserId
),
(WindowsFirewall
| where SourceIP in (IPList) or DestinationIP in (IPList) or SourceIP in (ips) or DestinationIP in (ips)
| extend IPMatch = case( SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", "None")
),
(_Im_NetworkSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "SourceIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity = SrcIpAddr //, AccountCustomEntity =User
),
(_Im_NetworkSession(dstipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "DestinationIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity =  DstIpAddr //, AccountCustomEntity =User
),
(_Im_WebSession(url_has_any=domains)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(_Im_WebSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (domains)  
| extend timestamp = TimeGenerated, DNSName = DestinationHost, IPCustomEntity = SourceHost
),
(Event
//This query uses sysmon data depending on table name used this may need updating
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| where EventDetail has_any (sha256Hashes) or EventDetail has_any (sha256s)
| parse EventDetail with * 'SHA256=' SHA256 '",' *
| extend Type = strcat(Type, ": ", Source), Account = UserName, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, FileHash
),
(DeviceFileEvents
| where SHA256 in~ (sha256Hashes) or SHA256 in~ (sha256s)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (sha256Hashes) or TargetFileSHA256 in~ (sha256s)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(CommonSecurityLog
| where FileHash in (sha256Hashes) or FileHash in (sha256s)
| extend timestamp = TimeGenerated
)
)

```

## NOBELIUM - Domain, Hash and IP IOCs - May 2021

'Identifies a match across various data feeds for domains, hashes and IP IOCs related to NOBELIUM.
Ref: https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1204.001|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | CiscoUmbrellaDataConnector |
|DetectionId | 677da133-e487-4108-a150-5b926591a92b |
|DataTypes | Cisco_Umbrella_dns_CL |
|QueryFrequency | 6h |
|QueryPeriod | 6h |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | Medium |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NOBELIUM_IOCsMay2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let iocs = externaldata(DateAdded:string,FirstSeen:string,IoC:string,Type:string,TLP:string)
[@"https://raw.githubusercontent.com/microsoft/mstic/master/Indicators/May21-NOBELIUM/May21NOBELIUMIoCs.csv"] with (format="csv", ignoreFirstRecord=True);
let sha256s = (iocs | where Type =~ "SHA256"| project IoC);
let ips = (iocs | where Type =~ "IP"| project IoC);
let IPList = dynamic(["192.99.221.77","83.171.237.173"]);
let ips_list=toscalar(ips | summarize makeset(IoC));
let full_ip_list= array_concat(ips_list, IPList);
let domains = (iocs | where Type =~ "Domain"| project IoC);
let domain_list=toscalar(domains | summarize make_set(IoC));
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let sha256Hashes = dynamic(["2523f94bd4fba4af76f4411fe61084a7e7d80dec163c9ccba9226c80b8b31252",
"d035d394a82ae1e44b25e273f99eae8e2369da828d6b6fdb95076fd3eb5de142",
"94786066a64c0eb260a28a2959fcd31d63d175ade8b05ae682d3f6f9b2a5a916",
"48b5fb3fa3ea67c2bc0086c41ec755c39d748a7100d71b81f618e82bf1c479f0",
"ee44c0692fd2ab2f01d17ca4b58ca6c7f79388cbc681f885bb17ec946514088c",
"ee42ddacbd202008bcc1312e548e1d9ac670dd3d86c999606a3a01d464a2a330"]);
(union isfuzzy=true
(CommonSecurityLog
| where SourceIP in (IPList) or DestinationIP in (IPList) or DestinationHostName in~ (domains) or RequestURL has_any (domains) or Message has_any (IPList)
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend IPMatch = case(SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", MessageIP in (IPList), "Message", RequestURL in (domains), "RequestUrl", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", MessageIP in (IPList), "Message", "NoMatch") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIP, IPMatch == "DestinationIP", DestinationIP, IPMatch == "Message", MessageIP, "NoMatch"), AccountCustomEntity = SourceUserID
),
(_Im_Dns (domain_has_any=todynamic(domain_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(_Im_Dns (response_has_any_prefix=todynamic(full_ip_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(VMConnection
| where SourceIp in (IPList) or DestinationIp in (IPList) or SourceIp in (ips) or DestinationIp in (ips) or RemoteDnsCanonicalNames has_any (domains)
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| extend IPMatch = case( SourceIp in (IPList), "SourceIP", DestinationIp in (IPList), "DestinationIP",  SourceIp in (ips), "SourceIP", DestinationIp in (ips), "DestinationIP", "None") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIp, IPMatch == "DestinationIP", DestinationIp, "NoMatch"), HostCustomEntity = Computer
),
(OfficeActivity
| where ClientIP in (IPList) or ClientIP in (ips)
| extend timestamp = TimeGenerated, IPCustomEntity = ClientIP, AccountCustomEntity = UserId
),
(WindowsFirewall
| where SourceIP in (IPList) or DestinationIP in (IPList) or SourceIP in (ips) or DestinationIP in (ips)
| extend IPMatch = case( SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", "None")
),
(_Im_NetworkSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "SourceIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity = SrcIpAddr //, AccountCustomEntity =User
),
(_Im_NetworkSession(dstipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "DestinationIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity =  DstIpAddr //, AccountCustomEntity =User
),
(_Im_WebSession(url_has_any=domains)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(_Im_WebSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (domains)  
| extend timestamp = TimeGenerated, DNSName = DestinationHost, IPCustomEntity = SourceHost
),
(Event
//This query uses sysmon data depending on table name used this may need updating
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| where EventDetail has_any (sha256Hashes) or EventDetail has_any (sha256s)
| parse EventDetail with * 'SHA256=' SHA256 '",' *
| extend Type = strcat(Type, ": ", Source), Account = UserName, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, FileHash
),
(DeviceFileEvents
| where SHA256 in~ (sha256Hashes) or SHA256 in~ (sha256s)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (sha256Hashes) or TargetFileSHA256 in~ (sha256s)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(CommonSecurityLog
| where FileHash in (sha256Hashes) or FileHash in (sha256s)
| extend timestamp = TimeGenerated
)
)

```

## NOBELIUM - Domain, Hash and IP IOCs - May 2021

'Identifies a match across various data feeds for domains, hashes and IP IOCs related to NOBELIUM.
Ref: https://www.microsoft.com/security/blog/2021/05/27/new-sophisticated-email-based-attack-from-nobelium/'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1204.001|
|Platform | |
|DetectionType | Analytics |
|ConnectorId | Corelight |
|DetectionId | 677da133-e487-4108-a150-5b926591a92b |
|DataTypes | Corelight_CL |
|QueryFrequency | 6h |
|QueryPeriod | 6h |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | Medium |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NOBELIUM_IOCsMay2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let iocs = externaldata(DateAdded:string,FirstSeen:string,IoC:string,Type:string,TLP:string)
[@"https://raw.githubusercontent.com/microsoft/mstic/master/Indicators/May21-NOBELIUM/May21NOBELIUMIoCs.csv"] with (format="csv", ignoreFirstRecord=True);
let sha256s = (iocs | where Type =~ "SHA256"| project IoC);
let ips = (iocs | where Type =~ "IP"| project IoC);
let IPList = dynamic(["192.99.221.77","83.171.237.173"]);
let ips_list=toscalar(ips | summarize makeset(IoC));
let full_ip_list= array_concat(ips_list, IPList);
let domains = (iocs | where Type =~ "Domain"| project IoC);
let domain_list=toscalar(domains | summarize make_set(IoC));
let IPRegex = '[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}';
let sha256Hashes = dynamic(["2523f94bd4fba4af76f4411fe61084a7e7d80dec163c9ccba9226c80b8b31252",
"d035d394a82ae1e44b25e273f99eae8e2369da828d6b6fdb95076fd3eb5de142",
"94786066a64c0eb260a28a2959fcd31d63d175ade8b05ae682d3f6f9b2a5a916",
"48b5fb3fa3ea67c2bc0086c41ec755c39d748a7100d71b81f618e82bf1c479f0",
"ee44c0692fd2ab2f01d17ca4b58ca6c7f79388cbc681f885bb17ec946514088c",
"ee42ddacbd202008bcc1312e548e1d9ac670dd3d86c999606a3a01d464a2a330"]);
(union isfuzzy=true
(CommonSecurityLog
| where SourceIP in (IPList) or DestinationIP in (IPList) or DestinationHostName in~ (domains) or RequestURL has_any (domains) or Message has_any (IPList)
| parse Message with * '(' DNSName ')' * 
| extend MessageIP = extract(IPRegex, 0, Message)
| extend IPMatch = case(SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", MessageIP in (IPList), "Message", RequestURL in (domains), "RequestUrl", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", MessageIP in (IPList), "Message", "NoMatch") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIP, IPMatch == "DestinationIP", DestinationIP, IPMatch == "Message", MessageIP, "NoMatch"), AccountCustomEntity = SourceUserID
),
(_Im_Dns (domain_has_any=todynamic(domain_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(_Im_Dns (response_has_any_prefix=todynamic(full_ip_list))
| extend DestinationIPAddress = DnsResponseName, DNSName = DnsQuery, Host = Dvc
| extend timestamp = TimeGenerated, IPCustomEntity = SrcIpAddr, HostCustomEntity = Host
),
(VMConnection
| where SourceIp in (IPList) or DestinationIp in (IPList) or SourceIp in (ips) or DestinationIp in (ips) or RemoteDnsCanonicalNames has_any (domains)
| parse RemoteDnsCanonicalNames with * '["' DNSName '"]' *
| extend IPMatch = case( SourceIp in (IPList), "SourceIP", DestinationIp in (IPList), "DestinationIP",  SourceIp in (ips), "SourceIP", DestinationIp in (ips), "DestinationIP", "None") 
| extend timestamp = TimeGenerated, IPCustomEntity = case(IPMatch == "SourceIP", SourceIp, IPMatch == "DestinationIP", DestinationIp, "NoMatch"), HostCustomEntity = Computer
),
(OfficeActivity
| where ClientIP in (IPList) or ClientIP in (ips)
| extend timestamp = TimeGenerated, IPCustomEntity = ClientIP, AccountCustomEntity = UserId
),
(WindowsFirewall
| where SourceIP in (IPList) or DestinationIP in (IPList) or SourceIP in (ips) or DestinationIP in (ips)
| extend IPMatch = case( SourceIP in (IPList), "SourceIP", DestinationIP in (IPList), "DestinationIP", SourceIP in (ips), "SourceIP", DestinationIP in (ips), "DestinationIP", "None")
),
(_Im_NetworkSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "SourceIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity = SrcIpAddr //, AccountCustomEntity =User
),
(_Im_NetworkSession(dstipaddr_has_any_prefix=full_ip_list)
  | extend IPMatch =  "DestinationIP"
  | extend timestamp = TimeGenerated, HostCustomEntity = Dvc , IPCustomEntity =  DstIpAddr //, AccountCustomEntity =User
),
(_Im_WebSession(url_has_any=domains)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(_Im_WebSession(srcipaddr_has_any_prefix=full_ip_list)
  | extend timestamp=TimeGenerated, HostCustomEntity=Dvc , DNSName=tostring(parse_url(Url)["Host"]), AccountCustomEntity=User
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (domains)  
| extend timestamp = TimeGenerated, DNSName = DestinationHost, IPCustomEntity = SourceHost
),
(Event
//This query uses sysmon data depending on table name used this may need updating
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| where EventDetail has_any (sha256Hashes) or EventDetail has_any (sha256s)
| parse EventDetail with * 'SHA256=' SHA256 '",' *
| extend Type = strcat(Type, ": ", Source), Account = UserName, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, FileHash
),
(DeviceFileEvents
| where SHA256 in~ (sha256Hashes) or SHA256 in~ (sha256s)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (sha256Hashes) or TargetFileSHA256 in~ (sha256s)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(CommonSecurityLog
| where FileHash in (sha256Hashes) or FileHash in (sha256s)
| extend timestamp = TimeGenerated
)
)

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | |
|DetectionType | Analytics |
|ConnectorId | SquidProxy |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | SquidProxy_CL |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | DNS |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | DnsEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | AzureMonitor(VMInsights) |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | VMConnection |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | CiscoASA |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | CiscoASA |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | CiscoASA |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Analytics |
|ConnectorId | PaloAltoNetworks |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | CommonSecurityLog |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Analytics |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | DeviceFileEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

## Known NICKEL domains and hashes

'IOC domains and hash values for tools and malware used by NICKEL. 
 Matches domain name, hash IOCs and M365 Defender sigs related to the NICKEL activity group with CommonSecurityLog, DnsEvents, VMConnection and SecurityEvents dataTypes.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Windows|
|DetectionType | Analytics |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 9122a9cb-916b-4d98-a199-1b7b0af8d598 |
|DataTypes | DeviceFileEvents |
|QueryFrequency | 1d |
|QueryPeriod | 1d |
|TriggerOperator | gt |
|TriggerThreshold | 0.0 |
|DetectionSeverity | High |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Detections/MultipleDataSources/NICKELIOCsNov2021.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let DomainNames = dynamic(["beesweiserdog.com", 
                          "bluehostfit.com", 
                          "business-toys.com", 
                          "cleanskycloud.com", 
                          "cumberbat.com", 
                          "czreadsecurity.com", 
                          "dgtresorgouv.com", 
                          "dimediamikedask.com", 
                          "diresitioscon.com", 
                          "elcolectador.com", 
                          "elperuanos.org", 
                          "eprotectioneu.com", 
                          "fheacor.com", 
                          "followthewaterdata.com", 
                          "francevrteepress.com", 
                          "futtuhy.com", 
                          "gardienweb.com", 
                          "heimflugaustr.com", 
                          "ivpsers.com", 
                          "jkeducation.org", 
                          "micrlmb.com", 
                          "muthesck.com", 
                          "netscalertech.com", 
                          "newgoldbalmap.com", 
                          "news-laestrella.com", 
                          "noticialif.com", 
                          "opentanzanfoundation.com", 
                          "optonlinepress.com", 
                          "palazzochigi.com", 
                          "pandemicacre.com", 
                          "papa-ser.com", 
                          "pekematclouds.com", 
                          "pipcake.com", 
                          "popularservicenter.com", 
                          "projectsyndic.com", 
                          "qsadtv.com", 
                          "sankreal.com", 
                          "scielope.com", 
                          "seoamdcopywriting.com", 
                          "slidenshare.com", 
                          "somoswake.com", 
                          "squarespacenow.com", 
                          "subapostilla.com", 
                          "suzukicycles.net", 
                          "tatanotakeeps.com", 
                          "tijuanazxc.com", 
                          "transactioninfo.net", 
                          "eurolabspro.com", 
                          "adelluminate.com", 
                          "headhunterblue.com", 
                          "primenuesty.com" 
                          ]);
let SHA256Hashes = dynamic (["02daf4544bcefb2de865d0b45fc406bee3630704be26a9d6da25c9abe906e7d2", 
                            "0a45ec3da31838aa7f56e4cbe70d5b3b3809029f9159ff0235837e5b7a4cb34c", 
                            "0d7965489810446ca7acc7a2160795b22e452a164261313c634a6529a0090a0c", 
                            "10bb4e056fd19f2debe61d8fc5665434f56064a93ca0ec0bef946a4c3e098b95", 
                            "12d914f24fe5501e09f5edf503820cc5fe8b763827a1c6d44cdb705e48651b21", 
                            "1899f761123fedfeba0fee6a11f830a29cd3653bcdcf70380b72a05b921b4b49", 
                            "22e68e366dd3323e5bb68161b0938da8e1331e4f1c1819c8e84a97e704d93844", 
                            "259783405ec2cb37fdd8fd16304328edbb6a0703bc3d551eba252d9b450554ef", 
                            "26debed09b1bbf24545e3b4501b799b66a0146d4020f882776465b5071e91822", 
                            "35c5f22bb11f7dd7a2bb03808e0337cb7f9c0d96047b94c8afdab63efc0b9bb2", 
                            "3ae2d9ffa4e53519e62cc0a75696f9023f9cce09b0a917f25699b48d0f7c4838", 
                            "3bac2e459c69fcef8c1c93c18e5f4f3e3102d8d0f54a63e0650072aeb2a5fa65", 
                            "3c0bf69f6faf85523d9e60d13218e77122b2adb0136ffebbad0f39f3e3eed4e6", 
                            "3dc0001a11d54925d2591aec4ea296e64f1d4fdf17ff3343ddeea82e9bd5e4f1", 
                            "3fd73af89e94af180b1fbf442bbfb7d7a6c4cf9043abd22ac0aa2f8149bafc90", 
                            "6854df6aa0af46f7c77667c450796d5658b3058219158456e869ebd39a47d54b", 
                            "6b79b807a66c786bd2e57d1c761fc7e69dd9f790ffab7ce74086c4115c9305ce", 
                            "7944a86fbef6238d2a55c14c660c3a3d361c172f6b8fa490686cc8889b7a51a0", 
                            "926904f7c0da13a6b8689c36dab9d20b3a2e6d32f212fca9e5f8cf2c6055333c", 
                            "95e98c811ea9d212673d0e84046d6da94cbd9134284275195800278593594b5a", 
                            "a142625512e5372a1728595be19dbee23eea50524b4827cb64ed5aaeaaa0270b", 
                            "afe5e9145882e0b98a795468a4c0352f5b1ddb7b4a534783c9e8fc366914cf6a", 
                            "b9027bad09a9f5c917cf0f811610438e46e42e5e984a8984b6d69206ceb74124", 
                            "c132d59a3bf0099e0f9f5667daf7b65dba66780f4addd88f04eecae47d5d99fa", 
                            "c9a5765561f52bbe34382ce06f4431f7ac65bafe786db5de89c29748cf371dda", 
                            "ce0408f92635e42aadc99da3cc1cbc0044e63441129c597e7aa1d76bf2700c94", 
                            "ce47bacc872516f91263f5e59441c54f14e9856cf213ca3128470217655fc5e6", 
                            "d0fe4562970676e30a4be8cb4923dc9bfd1fca8178e8e7fea0f3f02e0c7435ce", 
                            "d5b36648dc9828e69242b57aca91a0bb73296292bf987720c73fcd3d2becbae6", 
                            "e72d142a2bc49572e2d99ed15827fc27c67fc0999e90d4bf1352b075f86a83ba"
                            ]);
let SigNames = dynamic(["Backdoor:Win32/Leeson", "Trojan:Win32/Kechang", "Backdoor:Win32/Nightimp!dha", "Trojan:Win32/QuarkBandit.A!dha", "TrojanSpy:Win32/KeyLogger"]);
(union isfuzzy=true
(CommonSecurityLog 
| parse Message with * '(' DNSName ')' * 
| where isnotempty(FileHash)
| where FileHash in (SHA256Hashes) or DNSName in~ (DomainNames)
| extend Account = SourceUserID, Computer = DeviceName, IPAddress = SourceIP
),
(_Im_Dns(domain_has_any = DomainNames)
| extend DNSName = DnsQuery
| extend IPAddress = SrcIpAddr
),
(_Im_WebSession(url_has_any = DomainNames)
| extend DNSName = tostring(parse_url(Url)["Host"])
| extend IPAddress = SrcIpAddr
),
(Event
//This query uses sysmon data depending on table name used this may need updataing
| where Source == "Microsoft-Windows-Sysmon"
| extend EvData = parse_xml(EventData)
| extend EventDetail = EvData.DataItem.EventData.Data
| extend Hashes = EventDetail.[16].["#text"]
| parse Hashes with * 'SHA256=' SHA256 ',' * 
| where isnotempty(Hashes)
| where Hashes in (SHA256Hashes) 
| extend Account = UserName
),
(DeviceFileEvents
| where SHA256 in~ (SHA256Hashes)
| extend Account = RequestAccountName, Computer = DeviceName, IPAddress = RequestSourceIP, CommandLine = InitiatingProcessCommandLine, FileHash = SHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(imFileEvent
| where TargetFileSHA256 in~ (SHA256Hashes)
| extend Account = ActorUsername, Computer = DvcHostname, IPAddress = SrcIpAddr, CommandLine = ActingProcessCommandLine, FileHash = TargetFileSHA256
| project Type, TimeGenerated, Computer, Account, IPAddress, CommandLine, FileHash
),
(DeviceNetworkEvents
| where RemoteUrl in~ (DomainNames)
| extend Computer = DeviceName, IPAddress = LocalIP, Account = InitiatingProcessAccountName
| project Type, TimeGenerated, Computer, Account, IPAddress, RemoteUrl
),
(SecurityAlert
| where ProductName == "Microsoft Defender Advanced Threat Protection"
| extend ThreatName = tostring(parse_json(ExtendedProperties).ThreatName)
| where isnotempty(ThreatName)
| where ThreatName has_any (SigNames)
| extend Computer = tostring(parse_json(Entities)[0].HostName)
),
(AzureDiagnostics 
| where ResourceType == "AZUREFIREWALLS"
| where Category == "AzureFirewallApplicationRule"
| parse msg_s with Protocol 'request from ' SourceHost ':' SourcePort 'to ' DestinationHost ':' DestinationPort '. Action:' Action
| where isnotempty(DestinationHost)
| where DestinationHost has_any (DomainNames)  
| extend DNSName = DestinationHost 
| extend IPAddress = SourceHost
)
)
| extend timestamp = TimeGenerated, AccountCustomEntity = Account, HostCustomEntity = Computer, IPCustomEntity = IPAddress

```

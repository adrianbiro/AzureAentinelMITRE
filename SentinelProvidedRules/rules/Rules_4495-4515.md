# Rules: 4495-4515

## User Role altered on SQL Server

This hunting query identifies user role altered on SQL Server
This query is based on the SQLEvent KQL Parser function (link below) 
SQLEvent KQL Parser provided at https://github.com/Azure/Azure-Sentinel/tree/master/Parsers/SQLSever
Detailed blog post on Monitoring SQL Server with Microsoft Sentinel https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-sql-server-with-azure-sentinel/ba-p/1502960

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1078|
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(WindowsEventLogs) |
|DetectionId | 80a420b3-6a97-4b8f-9d86-4b43ee522fb2 |
|DataTypes | Event |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SQLServer/SQL-UserRoleChanged.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// SQLEvent is not the table name, it is the function name that should already be imported into your workspace.
// The underlying table where the data exists is the Event table.
// This query looking for Alter role commands and extracts username which was altered and target objectName
SQLEvent
| where Statement contains "Alter role" and Statement has "add member"
| parse Statement with * "ADD MEMBER [" TargetUser:string "]" *
| project TimeGenerated, Computer, Action, ClientIP, CurrentUser, DatabaseName, TargetUser, ObjectName, Statement
| extend timestamp = TimeGenerated, AccountCustomEntity = CurrentUser, IPCustomEntity = ClientIP  

```

## New User created on SQL Server

This hunting query identifies creation of a new user from SQL Server
This query is based on the SQLEvent KQL Parser function (link below) 
SQLEvent KQL Parser provided at https://github.com/Azure/Azure-Sentinel/tree/master/Parsers/SQLSever
Detailed blog post on Monitoring SQL Server with Microsoft Sentinel https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-sql-server-with-azure-sentinel/ba-p/1502960

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1136|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(WindowsEventLogs) |
|DetectionId | 2b96760d-5307-44f0-94bd-8cf0ec52b1fb |
|DataTypes | Event |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SQLServer/SQL-New_UserCreated.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// SQLEvent is not the table name, it is the function name that should already be imported into your workspace.
// The underlying table where the data exists is the Event table.
// This query checks for new user account created on SQL Server using the SQLEvent() parser
//
SQLEvent
| where Statement has "Create Login"
| parse Statement with "CREATE LOGIN [" TargetUser:string "]" *
| project TimeGenerated, Computer, Action, ClientIP, CurrentUser, DatabaseName, TargetUser, ObjectName, Statement
| extend timestamp = TimeGenerated, AccountCustomEntity = CurrentUser, IPCustomEntity = ClientIP 
```

## New User created on SQL Server

This hunting query identifies creation of a new user from SQL Server
This query is based on the SQLEvent KQL Parser function (link below) 
SQLEvent KQL Parser provided at https://github.com/Azure/Azure-Sentinel/tree/master/Parsers/SQLSever
Detailed blog post on Monitoring SQL Server with Microsoft Sentinel https://techcommunity.microsoft.com/t5/azure-sentinel/monitoring-sql-server-with-azure-sentinel/ba-p/1502960

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1136|
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(WindowsEventLogs) |
|DetectionId | 2b96760d-5307-44f0-94bd-8cf0ec52b1fb |
|DataTypes | Event |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/SQLServer/SQL-New_UserCreated.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// SQLEvent is not the table name, it is the function name that should already be imported into your workspace.
// The underlying table where the data exists is the Event table.
// This query checks for new user account created on SQL Server using the SQLEvent() parser
//
SQLEvent
| where Statement has "Create Login"
| parse Statement with "CREATE LOGIN [" TargetUser:string "]" *
| project TimeGenerated, Computer, Action, ClientIP, CurrentUser, DatabaseName, TargetUser, ObjectName, Statement
| extend timestamp = TimeGenerated, AccountCustomEntity = CurrentUser, IPCustomEntity = ClientIP 
```

## Possible Linux attack toolkit detected via Syslog data

'This query uses syslog data to alert on any attack toolkits associated with massive scanning or exploitation attempts against a known vulnerability.
Attackers may perform such operations as seen recently to exploit the remote code execution vulnerability in Log4j component of Apache to scope and prioritize post-compromise objectives.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Reconnaissance|
|TechniqueId | T1595|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 09e45ec6-ac42-4b5a-be69-54623c4aa062 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Linux_Toolkit_Detected.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where (exe has "java" and cmdline has "JNDI-Injection-Exploit") or (exe has "javac" and cmdline has "log4j-payload-generator") or (cmdline has "LogMePwn" and cmdline has "git clone")
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Possible Linux attack toolkit detected via Syslog data

'This query uses syslog data to alert on any attack toolkits associated with massive scanning or exploitation attempts against a known vulnerability.
Attackers may perform such operations as seen recently to exploit the remote code execution vulnerability in Log4j component of Apache to scope and prioritize post-compromise objectives.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Reconnaissance|
|TechniqueId | T1203|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 09e45ec6-ac42-4b5a-be69-54623c4aa062 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Linux_Toolkit_Detected.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where (exe has "java" and cmdline has "JNDI-Injection-Exploit") or (exe has "javac" and cmdline has "log4j-payload-generator") or (cmdline has "LogMePwn" and cmdline has "git clone")
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Possible Linux attack toolkit detected via Syslog data

'This query uses syslog data to alert on any attack toolkits associated with massive scanning or exploitation attempts against a known vulnerability.
Attackers may perform such operations as seen recently to exploit the remote code execution vulnerability in Log4j component of Apache to scope and prioritize post-compromise objectives.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1595|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 09e45ec6-ac42-4b5a-be69-54623c4aa062 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Linux_Toolkit_Detected.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where (exe has "java" and cmdline has "JNDI-Injection-Exploit") or (exe has "javac" and cmdline has "log4j-payload-generator") or (cmdline has "LogMePwn" and cmdline has "git clone")
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Possible Linux attack toolkit detected via Syslog data

'This query uses syslog data to alert on any attack toolkits associated with massive scanning or exploitation attempts against a known vulnerability.
Attackers may perform such operations as seen recently to exploit the remote code execution vulnerability in Log4j component of Apache to scope and prioritize post-compromise objectives.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1203|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 09e45ec6-ac42-4b5a-be69-54623c4aa062 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Linux_Toolkit_Detected.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where (exe has "java" and cmdline has "JNDI-Injection-Exploit") or (exe has "javac" and cmdline has "log4j-payload-generator") or (cmdline has "LogMePwn" and cmdline has "git clone")
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Linux scheduled task Aggregation

'This query aggregates information about all of the scheduled tasks (Cron jobs) and presents the data in a chart.
The aggregation is done based on unique user-commandline pairs. It returns how many times a command line has
been run from a particular user, how many computers that pair has run on, and what percentage that is of the
total number of computers in the tenant.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | eb09da09-6f6c-4502-bf74-f7b9f1343539 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskAggregation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron where the process name is "CRON" or "CROND", the severity level is info, and the SyslogMessage contains "CMD".
// It also parses out the user and commandline from the message.
let RawCommands = Syslog 
| where Facility =~ "cron" 
| where SeverityLevel =~ "info" 
| where ProcessName =~ "CRON" or ProcessName =~ "CROND"  
| where SyslogMessage contains "CMD " 
| project TenantId, TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| extend TrimmedSyslogMsg = trim_end(@"\)", SyslogMessage)
| parse TrimmedSyslogMsg with * "(" user  ") CMD (" cmdline 
| project TenantId, TimeGenerated, Computer, user, cmdline; 
// Count how many times a particular commandline has been seen based on unique Computer, User, and cmdline sets
let CommandCount = RawCommands
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), CmdlineCount = count() by Computer, user, cmdline; 
// Count how many computers have run a particular user and cmdline pair
let DistComputerCount = RawCommands
| summarize ComputerCount = dcount(Computer) by TenantId, user, cmdline; 
// Join above counts based on user and commandline pair
let CommandSummary = CommandCount | join (DistComputerCount) on user, cmdline
| project StartTime, EndTime, TenantId, user, CmdlineCount, ComputerCount, cmdline;
// Count the total number of computers reporting cron messages in the tenant
let TotalComputers = Syslog
| where Facility =~ "cron"
| summarize dcount(Computer) by TenantId ;
// Join the previous counts with the total computers count. Calculate the percentage of total computers value.
let FinalSummary = CommandSummary | join kind= leftouter (TotalComputers) on TenantId
| project StartTime, EndTime, user, TimesCmdlineSeen = CmdlineCount, CompsThatHaveRunCmdline = ComputerCount, 
AsPercentOfTotalComps = round(100 * (toreal(ComputerCount)/toreal(dcount_Computer)),2), cmdline
| order by user asc, TimesCmdlineSeen desc;
FinalSummary 
| extend timestamp = StartTime, AccountCustomEntity = user

```

## Squid data volume timeseries anomalies

'Malware infections or data exfiltration activity often leads to anomalies in network data volume
this hunting query looks for anomalies in the volume of bytes traversing a squid proxy. Anomalies require further
investigation to determine cause. This query presumes the default squid log format is being used.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | e472c490-4792-4f12-8b6b-6ab3e0404d35 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_volume_anomalies.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let timeframe = 1h;
let TimeSeriesData =
Syslog
| where TimeGenerated between(starttime..endtime)
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage),
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage),
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage),
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage),
         Bytes = toint(extract("([A-Z]+\\/[0-9]{3} )([0-9]+)",2,SyslogMessage)),
         contentType = extract("([a-z/]+$)",1,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where isnotempty(Bytes)
| make-series TotalBytesSent=sum(Bytes) on TimeGenerated from startofday(starttime) to startofday(endtime) step timeframe by ProcessName;
TimeSeriesData
| extend (anomalies, score, baseline) = series_decompose_anomalies(TotalBytesSent,3, -1, 'linefit')
| extend timestamp = TimeGenerated
| render timechart with (title="Squid Time Series anomalies")

```

## Squid data volume timeseries anomalies

'Malware infections or data exfiltration activity often leads to anomalies in network data volume
this hunting query looks for anomalies in the volume of bytes traversing a squid proxy. Anomalies require further
investigation to determine cause. This query presumes the default squid log format is being used.'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1030|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | e472c490-4792-4f12-8b6b-6ab3e0404d35 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_volume_anomalies.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let timeframe = 1h;
let TimeSeriesData =
Syslog
| where TimeGenerated between(starttime..endtime)
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage),
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage),
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage),
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage),
         Bytes = toint(extract("([A-Z]+\\/[0-9]{3} )([0-9]+)",2,SyslogMessage)),
         contentType = extract("([a-z/]+$)",1,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where isnotempty(Bytes)
| make-series TotalBytesSent=sum(Bytes) on TimeGenerated from startofday(starttime) to startofday(endtime) step timeframe by ProcessName;
TimeSeriesData
| extend (anomalies, score, baseline) = series_decompose_anomalies(TotalBytesSent,3, -1, 'linefit')
| extend timestamp = TimeGenerated
| render timechart with (title="Squid Time Series anomalies")

```

## Squid data volume timeseries anomalies

'Malware infections or data exfiltration activity often leads to anomalies in network data volume
this hunting query looks for anomalies in the volume of bytes traversing a squid proxy. Anomalies require further
investigation to determine cause. This query presumes the default squid log format is being used.'

|Name | Value |
| --- | --- |
|Tactic | Exfiltration|
|TechniqueId | T1071|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | e472c490-4792-4f12-8b6b-6ab3e0404d35 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_volume_anomalies.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let timeframe = 1h;
let TimeSeriesData =
Syslog
| where TimeGenerated between(starttime..endtime)
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage),
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage),
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage),
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage),
         Bytes = toint(extract("([A-Z]+\\/[0-9]{3} )([0-9]+)",2,SyslogMessage)),
         contentType = extract("([a-z/]+$)",1,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where isnotempty(Bytes)
| make-series TotalBytesSent=sum(Bytes) on TimeGenerated from startofday(starttime) to startofday(endtime) step timeframe by ProcessName;
TimeSeriesData
| extend (anomalies, score, baseline) = series_decompose_anomalies(TotalBytesSent,3, -1, 'linefit')
| extend timestamp = TimeGenerated
| render timechart with (title="Squid Time Series anomalies")

```

## Squid data volume timeseries anomalies

'Malware infections or data exfiltration activity often leads to anomalies in network data volume
this hunting query looks for anomalies in the volume of bytes traversing a squid proxy. Anomalies require further
investigation to determine cause. This query presumes the default squid log format is being used.'

|Name | Value |
| --- | --- |
|Tactic | Exfiltration|
|TechniqueId | T1030|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | e472c490-4792-4f12-8b6b-6ab3e0404d35 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_volume_anomalies.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let timeframe = 1h;
let TimeSeriesData =
Syslog
| where TimeGenerated between(starttime..endtime)
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage),
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage),
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage),
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage),
         Bytes = toint(extract("([A-Z]+\\/[0-9]{3} )([0-9]+)",2,SyslogMessage)),
         contentType = extract("([a-z/]+$)",1,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where isnotempty(Bytes)
| make-series TotalBytesSent=sum(Bytes) on TimeGenerated from startofday(starttime) to startofday(endtime) step timeframe by ProcessName;
TimeSeriesData
| extend (anomalies, score, baseline) = series_decompose_anomalies(TotalBytesSent,3, -1, 'linefit')
| extend timestamp = TimeGenerated
| render timechart with (title="Squid Time Series anomalies")

```

## Rare process running on a Linux host

'Looks for rare processes that are running on Linux hosts. Looks for process seen less than 14 times in last 7 days,
 or observed rate is less than 1% of of the average for the environment and fewer than 100.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | d0ae35df-0eaf-491f-b23e-8190e4f3ffe9 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/RareProcess_ForLxHost.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = starttime - 14d;
let count_threshold = 100;
let perc_threshold = 0.01;
let host_threshold = 14;
let basic=materialize(
Syslog | where TimeGenerated >= lookback
| summarize FullCount = count(), Count= countif(TimeGenerated between (starttime .. endtime)), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) 
by Computer, ProcessName
| where Count > 0 and Count < count_threshold);
let basic_avg = basic
| summarize Avg = avg(FullCount) by  ProcessName;
basic | project-away FullCount
| join kind=inner
basic_avg
on ProcessName | project-away ProcessName1
| where Count < host_threshold or (Count <= Avg*perc_threshold and Count < count_threshold)
| extend timestamp = StartTime, HostCustomEntity=Computer

```

## Rare process running on a Linux host

'Looks for rare processes that are running on Linux hosts. Looks for process seen less than 14 times in last 7 days,
 or observed rate is less than 1% of of the average for the environment and fewer than 100.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | d0ae35df-0eaf-491f-b23e-8190e4f3ffe9 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/RareProcess_ForLxHost.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = starttime - 14d;
let count_threshold = 100;
let perc_threshold = 0.01;
let host_threshold = 14;
let basic=materialize(
Syslog | where TimeGenerated >= lookback
| summarize FullCount = count(), Count= countif(TimeGenerated between (starttime .. endtime)), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) 
by Computer, ProcessName
| where Count > 0 and Count < count_threshold);
let basic_avg = basic
| summarize Avg = avg(FullCount) by  ProcessName;
basic | project-away FullCount
| join kind=inner
basic_avg
on ProcessName | project-away ProcessName1
| where Count < host_threshold or (Count <= Avg*perc_threshold and Count < count_threshold)
| extend timestamp = StartTime, HostCustomEntity=Computer

```

## Rare process running on a Linux host

'Looks for rare processes that are running on Linux hosts. Looks for process seen less than 14 times in last 7 days,
 or observed rate is less than 1% of of the average for the environment and fewer than 100.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | d0ae35df-0eaf-491f-b23e-8190e4f3ffe9 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/RareProcess_ForLxHost.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = starttime - 14d;
let count_threshold = 100;
let perc_threshold = 0.01;
let host_threshold = 14;
let basic=materialize(
Syslog | where TimeGenerated >= lookback
| summarize FullCount = count(), Count= countif(TimeGenerated between (starttime .. endtime)), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) 
by Computer, ProcessName
| where Count > 0 and Count < count_threshold);
let basic_avg = basic
| summarize Avg = avg(FullCount) by  ProcessName;
basic | project-away FullCount
| join kind=inner
basic_avg
on ProcessName | project-away ProcessName1
| where Count < host_threshold or (Count <= Avg*perc_threshold and Count < count_threshold)
| extend timestamp = StartTime, HostCustomEntity=Computer

```

# Rules: 4516-4536

## Rare process running on a Linux host

'Looks for rare processes that are running on Linux hosts. Looks for process seen less than 14 times in last 7 days,
 or observed rate is less than 1% of of the average for the environment and fewer than 100.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | d0ae35df-0eaf-491f-b23e-8190e4f3ffe9 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/RareProcess_ForLxHost.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = starttime - 14d;
let count_threshold = 100;
let perc_threshold = 0.01;
let host_threshold = 14;
let basic=materialize(
Syslog | where TimeGenerated >= lookback
| summarize FullCount = count(), Count= countif(TimeGenerated between (starttime .. endtime)), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) 
by Computer, ProcessName
| where Count > 0 and Count < count_threshold);
let basic_avg = basic
| summarize Avg = avg(FullCount) by  ProcessName;
basic | project-away FullCount
| join kind=inner
basic_avg
on ProcessName | project-away ProcessName1
| where Count < host_threshold or (Count <= Avg*perc_threshold and Count < count_threshold)
| extend timestamp = StartTime, HostCustomEntity=Computer

```

## Rare process running on a Linux host

'Looks for rare processes that are running on Linux hosts. Looks for process seen less than 14 times in last 7 days,
 or observed rate is less than 1% of of the average for the environment and fewer than 100.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | d0ae35df-0eaf-491f-b23e-8190e4f3ffe9 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/RareProcess_ForLxHost.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = starttime - 14d;
let count_threshold = 100;
let perc_threshold = 0.01;
let host_threshold = 14;
let basic=materialize(
Syslog | where TimeGenerated >= lookback
| summarize FullCount = count(), Count= countif(TimeGenerated between (starttime .. endtime)), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated) 
by Computer, ProcessName
| where Count > 0 and Count < count_threshold);
let basic_avg = basic
| summarize Avg = avg(FullCount) by  ProcessName;
basic | project-away FullCount
| join kind=inner
basic_avg
on ProcessName | project-away ProcessName1
| where Count < host_threshold or (Count <= Avg*perc_threshold and Count < count_threshold)
| extend timestamp = StartTime, HostCustomEntity=Computer

```

## Possible exploitation of Apache log4j component detected

'This hunting query looks for possible attempts to exploit a remote code execution vulnerability in the Log4j component of Apache. 
Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 38cc38c3-bd6c-470e-ae1a-3136a9ded97f |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Apache_log4j_Vulnerability.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let log4j_execve=()
{
  Syslog
  | where SyslogMessage has "AUOMS_EXECVE"
  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')
  | parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
  | where EventType =~ "AUOMS_EXECVE"
  | project TimeGenerated, EventType, Computer, EventData
  | extend EventData = trim_end('containerid=',EventData)
  | parse kind=regex EventData with * "success=" success " exit=" * "ppid=" ppid "pid=" pid
  "audit_user=" audit_user "auid=" * "user=" user " uid=" uid " group=" * "comm=\"" comm "\" exe=\"" exe
  "\"" * "cwd=\"" cwd "\" name=\"" name "\" (inode|nametype)=" * "(proctitle|cmdline)=" cmdline
  | extend cmdline = trim_end('redactors=.*',cmdline)
};
log4j_execve
  | where comm has_any ("wget","curl")
  | where cmdline has_any ("${jndi:ldap","${jndi:dns","${jndi:rmi","${jndi:corba","${jndi:iiop","${jndi:nis", "${jndi:nds")
  | project TimeGenerated, Computer, audit_user, user, cmdline
  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
  | sort by TimeGenerated desc

```

## Possible exploitation of Apache log4j component detected

'This hunting query looks for possible attempts to exploit a remote code execution vulnerability in the Log4j component of Apache. 
Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 38cc38c3-bd6c-470e-ae1a-3136a9ded97f |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Apache_log4j_Vulnerability.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let log4j_execve=()
{
  Syslog
  | where SyslogMessage has "AUOMS_EXECVE"
  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')
  | parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
  | where EventType =~ "AUOMS_EXECVE"
  | project TimeGenerated, EventType, Computer, EventData
  | extend EventData = trim_end('containerid=',EventData)
  | parse kind=regex EventData with * "success=" success " exit=" * "ppid=" ppid "pid=" pid
  "audit_user=" audit_user "auid=" * "user=" user " uid=" uid " group=" * "comm=\"" comm "\" exe=\"" exe
  "\"" * "cwd=\"" cwd "\" name=\"" name "\" (inode|nametype)=" * "(proctitle|cmdline)=" cmdline
  | extend cmdline = trim_end('redactors=.*',cmdline)
};
log4j_execve
  | where comm has_any ("wget","curl")
  | where cmdline has_any ("${jndi:ldap","${jndi:dns","${jndi:rmi","${jndi:corba","${jndi:iiop","${jndi:nis", "${jndi:nds")
  | project TimeGenerated, Computer, audit_user, user, cmdline
  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
  | sort by TimeGenerated desc

```

## Possible exploitation of Apache log4j component detected

'This hunting query looks for possible attempts to exploit a remote code execution vulnerability in the Log4j component of Apache. 
Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 38cc38c3-bd6c-470e-ae1a-3136a9ded97f |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Apache_log4j_Vulnerability.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let log4j_execve=()
{
  Syslog
  | where SyslogMessage has "AUOMS_EXECVE"
  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')
  | parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
  | where EventType =~ "AUOMS_EXECVE"
  | project TimeGenerated, EventType, Computer, EventData
  | extend EventData = trim_end('containerid=',EventData)
  | parse kind=regex EventData with * "success=" success " exit=" * "ppid=" ppid "pid=" pid
  "audit_user=" audit_user "auid=" * "user=" user " uid=" uid " group=" * "comm=\"" comm "\" exe=\"" exe
  "\"" * "cwd=\"" cwd "\" name=\"" name "\" (inode|nametype)=" * "(proctitle|cmdline)=" cmdline
  | extend cmdline = trim_end('redactors=.*',cmdline)
};
log4j_execve
  | where comm has_any ("wget","curl")
  | where cmdline has_any ("${jndi:ldap","${jndi:dns","${jndi:rmi","${jndi:corba","${jndi:iiop","${jndi:nis", "${jndi:nds")
  | project TimeGenerated, Computer, audit_user, user, cmdline
  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
  | sort by TimeGenerated desc

```

## Possible exploitation of Apache log4j component detected

'This hunting query looks for possible attempts to exploit a remote code execution vulnerability in the Log4j component of Apache. 
Attackers may attempt to launch arbitrary code by passing specific commands to a server, which are then logged and executed by the Log4j component.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 38cc38c3-bd6c-470e-ae1a-3136a9ded97f |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Apache_log4j_Vulnerability.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let log4j_execve=()
{
  Syslog
  | where SyslogMessage has "AUOMS_EXECVE"
  | where SyslogMessage has 'jndi' and SyslogMessage has_any ('ldap', 'dns', 'rmi', 'corba', 'iiop', 'nis', 'nds')
  | parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
  | where EventType =~ "AUOMS_EXECVE"
  | project TimeGenerated, EventType, Computer, EventData
  | extend EventData = trim_end('containerid=',EventData)
  | parse kind=regex EventData with * "success=" success " exit=" * "ppid=" ppid "pid=" pid
  "audit_user=" audit_user "auid=" * "user=" user " uid=" uid " group=" * "comm=\"" comm "\" exe=\"" exe
  "\"" * "cwd=\"" cwd "\" name=\"" name "\" (inode|nametype)=" * "(proctitle|cmdline)=" cmdline
  | extend cmdline = trim_end('redactors=.*',cmdline)
};
log4j_execve
  | where comm has_any ("wget","curl")
  | where cmdline has_any ("${jndi:ldap","${jndi:dns","${jndi:rmi","${jndi:corba","${jndi:iiop","${jndi:nis", "${jndi:nds")
  | project TimeGenerated, Computer, audit_user, user, cmdline
  | extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
  | sort by TimeGenerated desc

```

## Squid commonly abused TLDs

'Some top level domains (TLDs) are more commonly associated with malware for a range of reasons - including how easy domains on these TLDs are to obtain. 
Many of these may be undesirable from an enterprise policy perspective. The clientCount column provides an initial insight into how widespread the domain 
usage is across the estate. This query presumes the default squid log format is being used. http://www.squid-cache.org/Doc/config/access_log/'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1568|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 7aaa7675-1580-47d8-a404-039cb7284279 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_abused_tlds.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let suspicious_tlds = dynamic([ ".click", ".club", ".download",  ".xxx", ".xyz"]);
Syslog
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage), 
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage), 
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage), 
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where TLD in (suspicious_tlds)
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), clientCount = dcount(SourceIP) by TLD, User, URL
| order by TLD asc, clientCount desc
| extend timestamp = StartTime, AccountCustomEntity = User, URLCustomEntity = URL

```

## Squid commonly abused TLDs

'Some top level domains (TLDs) are more commonly associated with malware for a range of reasons - including how easy domains on these TLDs are to obtain. 
Many of these may be undesirable from an enterprise policy perspective. The clientCount column provides an initial insight into how widespread the domain 
usage is across the estate. This query presumes the default squid log format is being used. http://www.squid-cache.org/Doc/config/access_log/'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1008|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 7aaa7675-1580-47d8-a404-039cb7284279 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_abused_tlds.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let suspicious_tlds = dynamic([ ".click", ".club", ".download",  ".xxx", ".xyz"]);
Syslog
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage), 
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage), 
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage), 
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where TLD in (suspicious_tlds)
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), clientCount = dcount(SourceIP) by TLD, User, URL
| order by TLD asc, clientCount desc
| extend timestamp = StartTime, AccountCustomEntity = User, URLCustomEntity = URL

```

## Squid malformed requests

'Malformed web requests are sometimes used for reconnaissance to detect the presence of network security devices.
Hunting for a large number of requests from a single source may assist in locating compromised hosts. Note: internal sites may
be detected by this query and may need excluding on a individual basis. This query presumes the default squid log format is
being used.'

|Name | Value |
| --- | --- |
|Tactic | Discovery|
|TechniqueId | T1046|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | edbeec9f-86b9-475d-8a42-cc7b95ad2baa |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/squid_malformed_requests.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

Syslog
| where ProcessName contains "squid"
| extend URL = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :]*)",3,SyslogMessage), 
         SourceIP = extract("([0-9]+ )(([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3}))",2,SyslogMessage), 
         Status = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))",1,SyslogMessage), 
         HTTP_Status_Code = extract("(TCP_(([A-Z]+)(_[A-Z]+)*)|UDP_(([A-Z]+)(_[A-Z]+)*))/([0-9]{3})",8,SyslogMessage),
         User = extract("(CONNECT |GET )([^ ]* )([^ ]+)",3,SyslogMessage),
         RemotePort = extract("(CONNECT |GET )([^ ]*)(:)([0-9]*)",4,SyslogMessage),
         Domain = extract("(([A-Z]+ [a-z]{4,5}:\\/\\/)|[A-Z]+ )([^ :\\/]*)",3,SyslogMessage),
         Bytes = toint(extract("([A-Z]+\\/[0-9]{3} )([0-9]+)",2,SyslogMessage)),
         contentType = extract("([a-z/]+$)",1,SyslogMessage)
| extend TLD = extract("\\.[a-z]*$",0,Domain)
| where Domain !contains '.' and isnotempty(Domain)
| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), badRequestCount = count() by Domain, SourceIP, User, URL
| order by badRequestCount desc
| extend timestamp = StartTime, AccountCustomEntity = User, IPCustomEntity = SourceIP, URLCustomEntity = URL

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Editing Linux scheduled tasks through Crontab

'This query shows when users have edited or replaced the scheduled tasks using crontab. The events are bucketed into 10 minute intervals 
and all the actions that a particular used took are collected into the List of Actions. Default query is for seven days.'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1037|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 6f0f1821-5981-408a-930b-8b2ca60e9e6c |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/SchedTaskEditViaCrontab.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Pull messages from Syslog-cron logs where the process is crontab and the severity level is "info". Extract the User and Action information from the SyslogMessage
Syslog 
| where Facility =~ "cron" 
| where ProcessName =~ "crontab" 
| where SeverityLevel =~ "info" 
| project TimeGenerated, Computer, SeverityLevel, ProcessName, SyslogMessage
| parse SyslogMessage with * "(" user  ") " Action " (" *
// Only look for messages that contain edit or replace
| where Action contains "EDIT" or Action contains "REPLACE"
//| summarize all the actions into a single set based on 10 minute time intervals
| summarize ListOfActions = makeset(Action) by EventTime10MinInterval = bin(TimeGenerated, 10m), Computer, user   
| order by Computer asc nulls last, EventTime10MinInterval asc
| extend timestamp = EventTime10MinInterval, AccountCustomEntity = user, HostCustomEntity = Computer

```

## Suspicious Shell script detected

'This hunting query will help detect post compromise suspicious shell scripts that attackers use for downloading and executing malicious files.
This technique is often used by attackers and was recently used  to exploit a remote code execution vulnerability in the Log4j component of Apache in order to evade detection and stay persistent or for more exploitation in the network.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 3e43fe23-c6c0-45ca-b680-263e8afada95 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Suspicious_ShellScript_Activity.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| project TimeGenerated, EventType, Computer, EventData
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where exe has_any ("bash","dash")
| where cmdline matches regex  "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"
| where cmdline has "curl" and cmdline has "wget"
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Suspicious Shell script detected

'This hunting query will help detect post compromise suspicious shell scripts that attackers use for downloading and executing malicious files.
This technique is often used by attackers and was recently used  to exploit a remote code execution vulnerability in the Log4j component of Apache in order to evade detection and stay persistent or for more exploitation in the network.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 3e43fe23-c6c0-45ca-b680-263e8afada95 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Suspicious_ShellScript_Activity.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| project TimeGenerated, EventType, Computer, EventData
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where exe has_any ("bash","dash")
| where cmdline matches regex  "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"
| where cmdline has "curl" and cmdline has "wget"
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Suspicious Shell script detected

'This hunting query will help detect post compromise suspicious shell scripts that attackers use for downloading and executing malicious files.
This technique is often used by attackers and was recently used  to exploit a remote code execution vulnerability in the Log4j component of Apache in order to evade detection and stay persistent or for more exploitation in the network.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 3e43fe23-c6c0-45ca-b680-263e8afada95 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Suspicious_ShellScript_Activity.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| project TimeGenerated, EventType, Computer, EventData
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where exe has_any ("bash","dash")
| where cmdline matches regex  "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"
| where cmdline has "curl" and cmdline has "wget"
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Suspicious Shell script detected

'This hunting query will help detect post compromise suspicious shell scripts that attackers use for downloading and executing malicious files.
This technique is often used by attackers and was recently used  to exploit a remote code execution vulnerability in the Log4j component of Apache in order to evade detection and stay persistent or for more exploitation in the network.
For more details on Apache Log4j Remote Code Execution Vulnerability - https://community.riskiq.com/article/505098fc/description
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1053|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 3e43fe23-c6c0-45ca-b680-263e8afada95 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/Suspicious_ShellScript_Activity.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
Syslog
| where Facility == 'user'
| where SyslogMessage has "AUOMS_EXECVE"
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| where EventType =~ "AUOMS_EXECVE"
| project TimeGenerated, EventType, Computer, EventData
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
| where exe has_any ("bash","dash")
| where cmdline matches regex  "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}"
| where cmdline has "curl" and cmdline has "wget"
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

## Crypto currency miners EXECVE

'This query hunts through EXECVE syslog data generated by AUOMS to find instances of crypto currency miners being
downloaded.  It returns a table of suspicious command lines.
Find more details on collecting EXECVE data into Microsoft Sentinel - https://techcommunity.microsoft.com/t5/azure-sentinel/hunting-threats-on-linux-with-azure-sentinel/ba-p/1344431'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1059|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | 1ef1c38f-26dd-4e28-b884-5b3665352648 |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Syslog/CryptoCurrencyMiners.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
// Extract EventType and EventData from AUOMS Syslog message
Syslog
| parse SyslogMessage with "type=" EventType " audit(" * "): " EventData
| project TimeGenerated, EventType, Computer, EventData 
// Extract AUOMS_EXECVE details from EventData
| where EventType =~ "AUOMS_EXECVE"
| parse EventData with * "syscall=" syscall " syscall_r=" * " success=" success " exit=" exit " a0" * " ppid=" ppid " pid=" pid " audit_user=" audit_user " auid=" auid " user=" user " uid=" uid " group=" group " gid=" gid "effective_user=" effective_user " euid=" euid " set_user=" set_user " suid=" suid " filesystem_user=" filesystem_user " fsuid=" fsuid " effective_group=" effective_group " egid=" egid " set_group=" set_group " sgid=" sgid " filesystem_group=" filesystem_group " fsgid=" fsgid " tty=" tty " ses=" ses " comm=\"" comm "\" exe=\"" exe "\"" * "cwd=\"" cwd "\"" * "name=\"" name "\"" * "cmdline=\"" cmdline "\" containerid=" containerid
// Find wget and curl commands
| where comm in ("wget", "curl")
// Find command lines featuring known crypto currency miner names
| where cmdline contains "nicehashminer" or cmdline contains "ethminer" or cmdline contains "equihash" or cmdline contains "NsCpuCNMiner64" or cmdline contains "minergate" or cmdline contains "minerd" or cmdline contains "cpuminer" or cmdline contains "xmr-stak-cpu" or cmdline contains "xmrig" or cmdline contains "stratum+tcp" or cmdline contains "cryptonight" or cmdline contains "monero" or cmdline contains "oceanhole" or cmdline contains "dockerminer" or cmdline contains "xmrdemo"
| project TimeGenerated, Computer, audit_user, user, cmdline
| extend AccountCustomEntity = user, HostCustomEntity = Computer, timestamp = TimeGenerated
| sort by TimeGenerated desc

```

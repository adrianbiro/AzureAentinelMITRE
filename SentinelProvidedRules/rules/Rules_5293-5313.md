# Rules: 5293-5313

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | Collection|
|TechniqueId | T1114.002|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | Collection|
|TechniqueId | T1114.002|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | Collection|
|TechniqueId | T1114.002|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1078.004|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1078.004|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1078.004|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1078.004|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1114.002|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1114.002|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1114.002|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Application Granted EWS Permissions

'Finds AD applications granted permissions to read users mailboxes via Exchange Web Services (EWS). A threat actor could add these permissions to an application they control in order to gain persistent access to user's mail.
Review the applications granted these permissions to ensure they are required and were granted legitimately.'

|Name | Value |
| --- | --- |
|Tactic | PrivilegeEscalation|
|TechniqueId | T1114.002|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectoryIdentityProtection |
|DetectionId | c7941212-4ff9-4d2d-b38d-54d78fa087cc |
|DataTypes | SecurityAlert (IPC) |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/ApplicationGrantedEWSPermissions.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
AuditLogs
| where Category == "ApplicationManagement"
| where OperationName has "Add app role assignment to service principal"
| extend UA = tostring(AdditionalDetails[0].value)
| mv-expand TargetResources
| extend ModifiedProps = TargetResources.modifiedProperties
| mv-expand ModifiedProps
| where ModifiedProps.newValue has "Use Exchange Web Services with full access to all mailboxes"
| extend Action = ModifiedProps.newValue
| extend User = tolower(tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName))
| join kind=inner AuditLogs on CorrelationId
| mv-expand TargetResources1
| mv-expand TargetResources1.modifiedProperties
| project-reorder TargetResources1_modifiedProperties
| extend displayName_ = tostring(TargetResources1_modifiedProperties.displayName)
| extend AppId = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.AppId", tostring(TargetResources1_modifiedProperties.newValue), "")
| extend AppName = iff(tostring(TargetResources1_modifiedProperties.displayName) == "ServicePrincipal.DisplayName", tostring(TargetResources1_modifiedProperties.newValue), "")
| summarize make_set(AppName), make_set(AppId) by TimeGenerated, ActivityDisplayName, UA, User, Result, OperationName, tostring(InitiatedBy), bin(TimeGenerated, 1d), tostring(Action)
| where tostring(set_AppId) != '[""]'
| project-reorder TimeGenerated, User, set_AppName
| join kind=leftouter (SecurityAlert
| where ProviderName == "IPC"
| extend User = tolower(tostring(parse_json(ExtendedProperties).["User Account"]))
| summarize count_AlertName = count() by bin(TimeGenerated, 1d), User) on TimeGenerated, User
| extend NumberofAADAlerts = iif(isnotempty(count_AlertName), count_AlertName, 0)
| sort by NumberofAADAlerts desc
| extend AppName = tostring(set_AppName[1])
| extend AppID = tostring(set_AppId[1])
| project-away set_AppName, set_AppId
| project-reorder TimeGenerated, ActivityDisplayName, Action, User, NumberofAADAlerts, AppName, AppID
| extend timestamp = TimeGenerated, AccountCustomEntity = User

```

## Dormant User Update MFA and Logs In

'This querys look for users accounts that have not been successfully logged into recently, who then have a MFA method added or updated before logging in.
Threat actors may look to re-activate dormant accounts and use them for access by adding MFA methods in the hope that changes to such dormant accounts may go un-noticed.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1098|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | a67834b0-3359-40be-bf11-71faac93b509 |
|DataTypes | SigninLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/DormantUserUpdateMFAandLogsIn.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = endtime - 14d;
let active_users = (
    SigninLogs
    | where TimeGenerated between(lookback..starttime)
    | where ResultType == 0
    | extend UserPrincipalName == tolower(UserPrincipalName)
    | summarize by UserId);
AuditLogs
| where TimeGenerated between(starttime..endtime)
// Get users where they added MFA
| where OperationName =~ "User registered security info"
| extend TargetUser = tolower(tostring(TargetResources[0].userPrincipalName))
| extend UserId = tostring(TargetResources[0].id)
// Check and see if this activity was from a user who is considered not active
| where UserId !in (active_users)
// Further reduce FP by just looking at users who have successfully logged in recently as well (avoiding hits for users adding MFA but not actually logging in)
| join kind=inner (SigninLogs | where TimeGenerated  between(starttime..endtime) | where ResultType == 0 | summarize max(TimeGenerated), make_set(IPAddress), make_set(UserAgent), make_set(LocationDetails) by UserPrincipalName, UserId
) on UserId
| extend LogonLocation = set_LocationDetails[0], LogonUserAgent = set_UserAgent[0], LogonIP = set_IPAddress[0]
| project-rename MostRecentLogon = max_TimeGenerated
| project-reorder TimeGenerated, TargetUser, OperationName, ResultDescription, MostRecentLogon, LogonUserAgent, LogonLocation, LogonIP
| extend AccountCustomEntity = TargetUser, IPCustomEntity = LogonIP

```

## Dormant User Update MFA and Logs In

'This querys look for users accounts that have not been successfully logged into recently, who then have a MFA method added or updated before logging in.
Threat actors may look to re-activate dormant accounts and use them for access by adding MFA methods in the hope that changes to such dormant accounts may go un-noticed.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1098|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | a67834b0-3359-40be-bf11-71faac93b509 |
|DataTypes | SigninLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/DormantUserUpdateMFAandLogsIn.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = endtime - 14d;
let active_users = (
    SigninLogs
    | where TimeGenerated between(lookback..starttime)
    | where ResultType == 0
    | extend UserPrincipalName == tolower(UserPrincipalName)
    | summarize by UserId);
AuditLogs
| where TimeGenerated between(starttime..endtime)
// Get users where they added MFA
| where OperationName =~ "User registered security info"
| extend TargetUser = tolower(tostring(TargetResources[0].userPrincipalName))
| extend UserId = tostring(TargetResources[0].id)
// Check and see if this activity was from a user who is considered not active
| where UserId !in (active_users)
// Further reduce FP by just looking at users who have successfully logged in recently as well (avoiding hits for users adding MFA but not actually logging in)
| join kind=inner (SigninLogs | where TimeGenerated  between(starttime..endtime) | where ResultType == 0 | summarize max(TimeGenerated), make_set(IPAddress), make_set(UserAgent), make_set(LocationDetails) by UserPrincipalName, UserId
) on UserId
| extend LogonLocation = set_LocationDetails[0], LogonUserAgent = set_UserAgent[0], LogonIP = set_IPAddress[0]
| project-rename MostRecentLogon = max_TimeGenerated
| project-reorder TimeGenerated, TargetUser, OperationName, ResultDescription, MostRecentLogon, LogonUserAgent, LogonLocation, LogonIP
| extend AccountCustomEntity = TargetUser, IPCustomEntity = LogonIP

```

## Dormant User Update MFA and Logs In

'This querys look for users accounts that have not been successfully logged into recently, who then have a MFA method added or updated before logging in.
Threat actors may look to re-activate dormant accounts and use them for access by adding MFA methods in the hope that changes to such dormant accounts may go un-noticed.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1098|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | a67834b0-3359-40be-bf11-71faac93b509 |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/DormantUserUpdateMFAandLogsIn.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = endtime - 14d;
let active_users = (
    SigninLogs
    | where TimeGenerated between(lookback..starttime)
    | where ResultType == 0
    | extend UserPrincipalName == tolower(UserPrincipalName)
    | summarize by UserId);
AuditLogs
| where TimeGenerated between(starttime..endtime)
// Get users where they added MFA
| where OperationName =~ "User registered security info"
| extend TargetUser = tolower(tostring(TargetResources[0].userPrincipalName))
| extend UserId = tostring(TargetResources[0].id)
// Check and see if this activity was from a user who is considered not active
| where UserId !in (active_users)
// Further reduce FP by just looking at users who have successfully logged in recently as well (avoiding hits for users adding MFA but not actually logging in)
| join kind=inner (SigninLogs | where TimeGenerated  between(starttime..endtime) | where ResultType == 0 | summarize max(TimeGenerated), make_set(IPAddress), make_set(UserAgent), make_set(LocationDetails) by UserPrincipalName, UserId
) on UserId
| extend LogonLocation = set_LocationDetails[0], LogonUserAgent = set_UserAgent[0], LogonIP = set_IPAddress[0]
| project-rename MostRecentLogon = max_TimeGenerated
| project-reorder TimeGenerated, TargetUser, OperationName, ResultDescription, MostRecentLogon, LogonUserAgent, LogonLocation, LogonIP
| extend AccountCustomEntity = TargetUser, IPCustomEntity = LogonIP

```

## Dormant User Update MFA and Logs In

'This querys look for users accounts that have not been successfully logged into recently, who then have a MFA method added or updated before logging in.
Threat actors may look to re-activate dormant accounts and use them for access by adding MFA methods in the hope that changes to such dormant accounts may go un-noticed.'

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | T1098|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | a67834b0-3359-40be-bf11-71faac93b509 |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/DormantUserUpdateMFAandLogsIn.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let starttime = todatetime('{{StartTimeISO}}');
let endtime = todatetime('{{EndTimeISO}}');
let lookback = endtime - 14d;
let active_users = (
    SigninLogs
    | where TimeGenerated between(lookback..starttime)
    | where ResultType == 0
    | extend UserPrincipalName == tolower(UserPrincipalName)
    | summarize by UserId);
AuditLogs
| where TimeGenerated between(starttime..endtime)
// Get users where they added MFA
| where OperationName =~ "User registered security info"
| extend TargetUser = tolower(tostring(TargetResources[0].userPrincipalName))
| extend UserId = tostring(TargetResources[0].id)
// Check and see if this activity was from a user who is considered not active
| where UserId !in (active_users)
// Further reduce FP by just looking at users who have successfully logged in recently as well (avoiding hits for users adding MFA but not actually logging in)
| join kind=inner (SigninLogs | where TimeGenerated  between(starttime..endtime) | where ResultType == 0 | summarize max(TimeGenerated), make_set(IPAddress), make_set(UserAgent), make_set(LocationDetails) by UserPrincipalName, UserId
) on UserId
| extend LogonLocation = set_LocationDetails[0], LogonUserAgent = set_UserAgent[0], LogonIP = set_IPAddress[0]
| project-rename MostRecentLogon = max_TimeGenerated
| project-reorder TimeGenerated, TargetUser, OperationName, ResultDescription, MostRecentLogon, LogonUserAgent, LogonLocation, LogonIP
| extend AccountCustomEntity = TargetUser, IPCustomEntity = LogonIP

```

## Tracking Password Changes

'Identifies when a password change or reset occurs across multiple host and cloud based sources. 
Account manipulation including password changes and resets may aid adversaries in maintaining access to credentials 
and certain permission levels within an environment.'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | bac44fe4-c0bc-4e90-aa48-2e346fda803f |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let action = dynamic(["change ", "changed ", "reset "]);
let pWord = dynamic(["password ", "credentials "]);
(union isfuzzy=true
  (SecurityEvent
| where EventID in (4723,4724)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(WindowsEvent
| where EventID in (4723,4724)
| extend Activity=iff(EventID=='4723',"4723 - An attempt was made to change an account","4724 - An attempt was made to reset an account")
| extend TargetUserName = tostring(EventData.TargetUserName)
| extend Account =  strcat(tostring(EventData.SubjectDomainName),"\\", tostring(EventData.SubjectUserName))
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(AuditLogs
| where OperationName has_any (pWord) and OperationName has_any (action)
| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName) 
| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName) 
| where ResultDescription != "None" 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by OperationName = strcat(Category, " - ", OperationName, " - ", Result), Resource, UserId = TargetUserPrincipalName, Type
| extend ResultDescriptions = tostring(ResultDescriptions)
),
(OfficeActivity
| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))
| extend ResultDescriptions = case(
OfficeWorkload =~ "AzureActiveDirectory", tostring(ExtendedProperties),
OfficeWorkload has_any ("Exchange","OneDrive"), OfficeObjectId,
RecordType) 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescriptions), ActionCount = count() by Resource = OfficeWorkload, OperationName = strcat(Operation, " - ", ResultStatus), IPAddress = ClientIP, UserId, Type
),
(Syslog
| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(SyslogMessage), ActionCount = count() by Resource = HostName, OperationName = Facility , IPAddress = HostIP, ProcessName, Type
),
(SigninLogs
| where OperationName =~ "Sign-in activity" and ResultType has_any ("50125", "50133")
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by Resource, OperationName = strcat(OperationName, " - ", ResultType), IPAddress, UserId = UserPrincipalName, Type
)
)
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = IPAddress
```

## Tracking Password Changes

'Identifies when a password change or reset occurs across multiple host and cloud based sources. 
Account manipulation including password changes and resets may aid adversaries in maintaining access to credentials 
and certain permission levels within an environment.'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078|
|Platform | Azure AD|
|DetectionType | Hunting |
|ConnectorId | AzureActiveDirectory |
|DetectionId | bac44fe4-c0bc-4e90-aa48-2e346fda803f |
|DataTypes | AuditLogs |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let action = dynamic(["change ", "changed ", "reset "]);
let pWord = dynamic(["password ", "credentials "]);
(union isfuzzy=true
  (SecurityEvent
| where EventID in (4723,4724)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(WindowsEvent
| where EventID in (4723,4724)
| extend Activity=iff(EventID=='4723',"4723 - An attempt was made to change an account","4724 - An attempt was made to reset an account")
| extend TargetUserName = tostring(EventData.TargetUserName)
| extend Account =  strcat(tostring(EventData.SubjectDomainName),"\\", tostring(EventData.SubjectUserName))
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(AuditLogs
| where OperationName has_any (pWord) and OperationName has_any (action)
| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName) 
| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName) 
| where ResultDescription != "None" 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by OperationName = strcat(Category, " - ", OperationName, " - ", Result), Resource, UserId = TargetUserPrincipalName, Type
| extend ResultDescriptions = tostring(ResultDescriptions)
),
(OfficeActivity
| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))
| extend ResultDescriptions = case(
OfficeWorkload =~ "AzureActiveDirectory", tostring(ExtendedProperties),
OfficeWorkload has_any ("Exchange","OneDrive"), OfficeObjectId,
RecordType) 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescriptions), ActionCount = count() by Resource = OfficeWorkload, OperationName = strcat(Operation, " - ", ResultStatus), IPAddress = ClientIP, UserId, Type
),
(Syslog
| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(SyslogMessage), ActionCount = count() by Resource = HostName, OperationName = Facility , IPAddress = HostIP, ProcessName, Type
),
(SigninLogs
| where OperationName =~ "Sign-in activity" and ResultType has_any ("50125", "50133")
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by Resource, OperationName = strcat(OperationName, " - ", ResultType), IPAddress, UserId = UserPrincipalName, Type
)
)
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = IPAddress
```

## Tracking Password Changes

'Identifies when a password change or reset occurs across multiple host and cloud based sources. 
Account manipulation including password changes and resets may aid adversaries in maintaining access to credentials 
and certain permission levels within an environment.'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078|
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | SecurityEvents |
|DetectionId | bac44fe4-c0bc-4e90-aa48-2e346fda803f |
|DataTypes | SecurityEvent |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let action = dynamic(["change ", "changed ", "reset "]);
let pWord = dynamic(["password ", "credentials "]);
(union isfuzzy=true
  (SecurityEvent
| where EventID in (4723,4724)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(WindowsEvent
| where EventID in (4723,4724)
| extend Activity=iff(EventID=='4723',"4723 - An attempt was made to change an account","4724 - An attempt was made to reset an account")
| extend TargetUserName = tostring(EventData.TargetUserName)
| extend Account =  strcat(tostring(EventData.SubjectDomainName),"\\", tostring(EventData.SubjectUserName))
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(AuditLogs
| where OperationName has_any (pWord) and OperationName has_any (action)
| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName) 
| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName) 
| where ResultDescription != "None" 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by OperationName = strcat(Category, " - ", OperationName, " - ", Result), Resource, UserId = TargetUserPrincipalName, Type
| extend ResultDescriptions = tostring(ResultDescriptions)
),
(OfficeActivity
| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))
| extend ResultDescriptions = case(
OfficeWorkload =~ "AzureActiveDirectory", tostring(ExtendedProperties),
OfficeWorkload has_any ("Exchange","OneDrive"), OfficeObjectId,
RecordType) 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescriptions), ActionCount = count() by Resource = OfficeWorkload, OperationName = strcat(Operation, " - ", ResultStatus), IPAddress = ClientIP, UserId, Type
),
(Syslog
| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(SyslogMessage), ActionCount = count() by Resource = HostName, OperationName = Facility , IPAddress = HostIP, ProcessName, Type
),
(SigninLogs
| where OperationName =~ "Sign-in activity" and ResultType has_any ("50125", "50133")
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by Resource, OperationName = strcat(OperationName, " - ", ResultType), IPAddress, UserId = UserPrincipalName, Type
)
)
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = IPAddress
```

## Tracking Password Changes

'Identifies when a password change or reset occurs across multiple host and cloud based sources. 
Account manipulation including password changes and resets may aid adversaries in maintaining access to credentials 
and certain permission levels within an environment.'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078|
|Platform | Linux|
|DetectionType | Hunting |
|ConnectorId | Syslog |
|DetectionId | bac44fe4-c0bc-4e90-aa48-2e346fda803f |
|DataTypes | Syslog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let action = dynamic(["change ", "changed ", "reset "]);
let pWord = dynamic(["password ", "credentials "]);
(union isfuzzy=true
  (SecurityEvent
| where EventID in (4723,4724)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(WindowsEvent
| where EventID in (4723,4724)
| extend Activity=iff(EventID=='4723',"4723 - An attempt was made to change an account","4724 - An attempt was made to reset an account")
| extend TargetUserName = tostring(EventData.TargetUserName)
| extend Account =  strcat(tostring(EventData.SubjectDomainName),"\\", tostring(EventData.SubjectUserName))
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(AuditLogs
| where OperationName has_any (pWord) and OperationName has_any (action)
| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName) 
| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName) 
| where ResultDescription != "None" 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by OperationName = strcat(Category, " - ", OperationName, " - ", Result), Resource, UserId = TargetUserPrincipalName, Type
| extend ResultDescriptions = tostring(ResultDescriptions)
),
(OfficeActivity
| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))
| extend ResultDescriptions = case(
OfficeWorkload =~ "AzureActiveDirectory", tostring(ExtendedProperties),
OfficeWorkload has_any ("Exchange","OneDrive"), OfficeObjectId,
RecordType) 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescriptions), ActionCount = count() by Resource = OfficeWorkload, OperationName = strcat(Operation, " - ", ResultStatus), IPAddress = ClientIP, UserId, Type
),
(Syslog
| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(SyslogMessage), ActionCount = count() by Resource = HostName, OperationName = Facility , IPAddress = HostIP, ProcessName, Type
),
(SigninLogs
| where OperationName =~ "Sign-in activity" and ResultType has_any ("50125", "50133")
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by Resource, OperationName = strcat(OperationName, " - ", ResultType), IPAddress, UserId = UserPrincipalName, Type
)
)
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = IPAddress
```

## Tracking Password Changes

'Identifies when a password change or reset occurs across multiple host and cloud based sources. 
Account manipulation including password changes and resets may aid adversaries in maintaining access to credentials 
and certain permission levels within an environment.'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | bac44fe4-c0bc-4e90-aa48-2e346fda803f |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/TrackingPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let action = dynamic(["change ", "changed ", "reset "]);
let pWord = dynamic(["password ", "credentials "]);
(union isfuzzy=true
  (SecurityEvent
| where EventID in (4723,4724)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(WindowsEvent
| where EventID in (4723,4724)
| extend Activity=iff(EventID=='4723',"4723 - An attempt was made to change an account","4724 - An attempt was made to reset an account")
| extend TargetUserName = tostring(EventData.TargetUserName)
| extend Account =  strcat(tostring(EventData.SubjectDomainName),"\\", tostring(EventData.SubjectUserName))
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(Activity), ActionCount = count() by Resource = Computer, OperationName = strcat("TargetAccount: ", TargetUserName), UserId = Account, Type
),
(AuditLogs
| where OperationName has_any (pWord) and OperationName has_any (action)
| extend InitiatedBy = tostring(parse_json(tostring(InitiatedBy.user)).userPrincipalName) 
| extend TargetUserPrincipalName = tostring(TargetResources[0].userPrincipalName) 
| where ResultDescription != "None" 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by OperationName = strcat(Category, " - ", OperationName, " - ", Result), Resource, UserId = TargetUserPrincipalName, Type
| extend ResultDescriptions = tostring(ResultDescriptions)
),
(OfficeActivity
| where (ExtendedProperties has_any (pWord) or ModifiedProperties has_any (pWord)) and (ExtendedProperties has_any (action) or ModifiedProperties has_any (action))
| extend ResultDescriptions = case(
OfficeWorkload =~ "AzureActiveDirectory", tostring(ExtendedProperties),
OfficeWorkload has_any ("Exchange","OneDrive"), OfficeObjectId,
RecordType) 
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescriptions), ActionCount = count() by Resource = OfficeWorkload, OperationName = strcat(Operation, " - ", ResultStatus), IPAddress = ClientIP, UserId, Type
),
(Syslog
| where SyslogMessage has_any (pWord) and SyslogMessage has_any (action)
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(SyslogMessage), ActionCount = count() by Resource = HostName, OperationName = Facility , IPAddress = HostIP, ProcessName, Type
),
(SigninLogs
| where OperationName =~ "Sign-in activity" and ResultType has_any ("50125", "50133")
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ResultDescriptions = makeset(ResultDescription), CorrelationIds = makeset(CorrelationId), ActionCount = count() by Resource, OperationName = strcat(OperationName, " - ", ResultType), IPAddress, UserId = UserPrincipalName, Type
)
)
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserId, IPCustomEntity = IPAddress
```

# Rules: 5503-5523

## Privileged Account Password Changes

'Identifies where Privileged Accounts have updated passwords or security information. This is joined with UEBA alerts to filter to only those accounts with a high investigation priority.
Ref : https://docs.microsoft.com/azure/active-directory/fundamentals/security-operations-privileged-accounts#things-to-monitor'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1078.004|
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | BehaviorAnalytics |
|DetectionId | d9cccaf9-d15e-4731-a62a-06d76e9c5e67 |
|DataTypes | BehaviorAnalytics |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/PrivilegedAccountPasswordChanges.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let priority_threshold = 5;
let admins = (IdentityInfo
| where AssignedRoles contains "Admin"
| summarize by tolower(AccountUPN));
AuditLogs
| where Category =~ "UserManagement"
| where OperationName has_any ("password", "security info")
| extend AccountUPN = tolower(tostring(TargetResources[0].userPrincipalName))
| where AccountUPN in (admins)
| join kind=inner (BehaviorAnalytics | where InvestigationPriority > priority_threshold | where isnotempty(UserPrincipalName)| summarize by UserPrincipalName | extend AccountUPN = tolower(UserPrincipalName)) on AccountUPN
| extend AccountCustomEntity = AccountUPN

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1189|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1189|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1189|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1203|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1203|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | InitialAccess|
|TechniqueId | T1203|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1189|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1189|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1189|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1071|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1203|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1203|
|Platform | AWS|
|DetectionType | Hunting |
|ConnectorId | AWS |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | AWSCloudTrail |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | CommandAndControl|
|TechniqueId | T1203|
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | AzureMonitor(IIS) |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | W3CIISLog |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

## Exploit and Pentest Framework User Agent

'There are several exploit and pen test frameworks that are being used by pen testers as well as attackers to 
compromise an environment and achieve their objective. The query tries to detect suspicious user agent strings 
used by these frameworks in some of the data sources that contain UserAgent field. 
This is based out of sigma rules described in references.
References: https://github.com/Neo23x0/sigma/blob/master/rules/proxy/proxy_ua_frameworks.yml'

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | T1189|
|Platform | Office 365|
|DetectionType | Hunting |
|ConnectorId | Office365 |
|DetectionId | df75ac6c-7b0b-40d2-82e4-191c012f1a07 |
|DataTypes | OfficeActivity |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/MultipleDataSources/UseragentExploitPentest.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

let UserAgentList = "Internet Explorer |Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1; SV1; InfoPath\\.2\\)|Mozilla/5\\.0 \\(Windows NT 10\\.0; Win32; x32; rv:60\\.0\\)|Mozilla/4\\.0 \\(compatible; Metasploit RSPEC\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.1; Windows NT\\)|Mozilla/4\\.0 \\(compatible; MSIE 6\\.0; Windows NT 5\\.1\\)|Mozilla/4\\.0 \\(compatible; MSIE 8\\.0; Windows NT 6\\.0; Trident/4\\.0\\)|Mozilla/4\\.0 \\(compatible; MSIE 7\\.0; Windows NT 6\\.0; Trident/4\\.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; \\.N|Mozilla/5\\.0 \\(Windows; U; Windows NT 5\\.1; en-US\\) AppleWebKit/525\\.13 \\(KHTML, like Gecko\\) Chrome/4\\.0\\.221\\.6 Safari/525\\.13|Mozilla/5\\.0 \\(compatible; MSIE 9\\.0; Windows NT 6\\.1; WOW64; Trident/5\\.0; MAAU\\)|Mozilla/5\\.0[^\\s]|Mozilla/4\\.0 \\(compatible; SPIPE/1\\.0|Mozilla/5\\.0 \\(Windows NT 6\\.3; rv:39\\.0\\) Gecko/20100101 Firefox/35\\.0|Sametime Community Agent|X-FORWARDED-FOR|DotDotPwn v2\\.1|SIPDROID|wordpress hash grabber|exploit|okhttp/";
// Excluding for IIS, as the main malicious usage for okhttp that we have seen was in the OfficeActivity logs and this can create noise for IIS.
let ExcludeIIS = "okhttp/";
(union isfuzzy=true
(OfficeActivity
| where ExtendedProperties has "UserAgent"
| extend UserAgent = extractjson("$[0].Value", ExtendedProperties, typeof(string))
| where UserAgent matches regex UserAgentList
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
W3CIISLog
| extend UserAgent = replace('\\+', ' ', csUserAgent) 
| where UserAgent matches regex UserAgentList
| where UserAgent !startswith ExcludeIIS
| extend SourceIP = cIP
| project TimeGenerated, Type, UserAgent, SourceIP
| extend IPCustomEntity = SourceIP
),
(
AWSCloudTrail
| where UserAgent matches regex UserAgentList
| extend SourceIP = SourceIpAddress
| project TimeGenerated, Type, UserAgent, SourceIP
))
| summarize min(TimeGenerated), max(TimeGenerated), count() by Type, UserAgent, SourceIP
| extend timestamp = min_TimeGenerated, IPCustomEntity = SourceIP

```

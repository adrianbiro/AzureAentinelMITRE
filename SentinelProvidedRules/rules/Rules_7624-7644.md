# Rules: 7624-7644

## Risky Sign-in with Device Registration

Looks for a new device registration in AAD preceded by medium or high-risk sign-in session for the same user within maximum 6h timeframe. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | ce2b03f8-92a4-4ec7-b55b-e9fa562fafa4 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToDeviceRegistration.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let registeredDevices=CloudAppEvents
| where ActionType =~ "Add registered owner to device."  
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.ModifiedProperties[0].NewValue) and isnotempty(RawEventData.Target[1].ID) and isnotempty(RawEventData.ModifiedProperties[1].NewValue)
| where AccountDisplayName =~ "Device Registration Service" 
| extend AccountUpn = tostring(RawEventData.ObjectId) 
| extend AccountObjectId = tostring(RawEventData.Target[1].ID) 
| extend DeviceObjectId = tostring(RawEventData.ModifiedProperties[0].NewValue) 
| extend DeviceDisplayName = tostring(RawEventData.ModifiedProperties[1].NewValue) 
| project DeviceRegistrationTimestamp=Timestamp,ReportId,AccountUpn,AccountObjectId,DeviceObjectId,DeviceDisplayName; 
let registeringUser= 
registeredDevices 
| distinct AccountObjectId; 
let hasRegisteringUser = isnotempty(toscalar(registeringUser));
let riskySignins=AADSignInEventsBeta
| where hasRegisteringUser
| where AccountObjectId in (registeringUser) 
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level. 
| where Application in ("Office 365 Exchange Online", "OfficeHome") 
| where isnotempty(SessionId) 
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn 
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn; 
registeredDevices 
| join riskySignins on AccountObjectId 
| where  DeviceRegistrationTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h 
| project-away AccountObjectId1
```

## Risky Sign-in with Device Registration

Looks for a new device registration in AAD preceded by medium or high-risk sign-in session for the same user within maximum 6h timeframe. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | ce2b03f8-92a4-4ec7-b55b-e9fa562fafa4 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToDeviceRegistration.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let registeredDevices=CloudAppEvents
| where ActionType =~ "Add registered owner to device."  
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.ModifiedProperties[0].NewValue) and isnotempty(RawEventData.Target[1].ID) and isnotempty(RawEventData.ModifiedProperties[1].NewValue)
| where AccountDisplayName =~ "Device Registration Service" 
| extend AccountUpn = tostring(RawEventData.ObjectId) 
| extend AccountObjectId = tostring(RawEventData.Target[1].ID) 
| extend DeviceObjectId = tostring(RawEventData.ModifiedProperties[0].NewValue) 
| extend DeviceDisplayName = tostring(RawEventData.ModifiedProperties[1].NewValue) 
| project DeviceRegistrationTimestamp=Timestamp,ReportId,AccountUpn,AccountObjectId,DeviceObjectId,DeviceDisplayName; 
let registeringUser= 
registeredDevices 
| distinct AccountObjectId; 
let hasRegisteringUser = isnotempty(toscalar(registeringUser));
let riskySignins=AADSignInEventsBeta
| where hasRegisteringUser
| where AccountObjectId in (registeringUser) 
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level. 
| where Application in ("Office 365 Exchange Online", "OfficeHome") 
| where isnotempty(SessionId) 
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn 
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn; 
registeredDevices 
| join riskySignins on AccountObjectId 
| where  DeviceRegistrationTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h 
| project-away AccountObjectId1
```

## Risky Sign-in with Device Registration

Looks for a new device registration in AAD preceded by medium or high-risk sign-in session for the same user within maximum 6h timeframe. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | ce2b03f8-92a4-4ec7-b55b-e9fa562fafa4 |
|DataTypes | AADSignInEventsBeta |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToDeviceRegistration.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let registeredDevices=CloudAppEvents
| where ActionType =~ "Add registered owner to device."  
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.ModifiedProperties[0].NewValue) and isnotempty(RawEventData.Target[1].ID) and isnotempty(RawEventData.ModifiedProperties[1].NewValue)
| where AccountDisplayName =~ "Device Registration Service" 
| extend AccountUpn = tostring(RawEventData.ObjectId) 
| extend AccountObjectId = tostring(RawEventData.Target[1].ID) 
| extend DeviceObjectId = tostring(RawEventData.ModifiedProperties[0].NewValue) 
| extend DeviceDisplayName = tostring(RawEventData.ModifiedProperties[1].NewValue) 
| project DeviceRegistrationTimestamp=Timestamp,ReportId,AccountUpn,AccountObjectId,DeviceObjectId,DeviceDisplayName; 
let registeringUser= 
registeredDevices 
| distinct AccountObjectId; 
let hasRegisteringUser = isnotempty(toscalar(registeringUser));
let riskySignins=AADSignInEventsBeta
| where hasRegisteringUser
| where AccountObjectId in (registeringUser) 
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level. 
| where Application in ("Office 365 Exchange Online", "OfficeHome") 
| where isnotempty(SessionId) 
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn 
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn; 
registeredDevices 
| join riskySignins on AccountObjectId 
| where  DeviceRegistrationTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h 
| project-away AccountObjectId1
```

## Risky Sign-in with Device Registration

Looks for a new device registration in AAD preceded by medium or high-risk sign-in session for the same user within maximum 6h timeframe. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | ce2b03f8-92a4-4ec7-b55b-e9fa562fafa4 |
|DataTypes | AADSignInEventsBeta |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToDeviceRegistration.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let registeredDevices=CloudAppEvents
| where ActionType =~ "Add registered owner to device."  
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.ModifiedProperties[0].NewValue) and isnotempty(RawEventData.Target[1].ID) and isnotempty(RawEventData.ModifiedProperties[1].NewValue)
| where AccountDisplayName =~ "Device Registration Service" 
| extend AccountUpn = tostring(RawEventData.ObjectId) 
| extend AccountObjectId = tostring(RawEventData.Target[1].ID) 
| extend DeviceObjectId = tostring(RawEventData.ModifiedProperties[0].NewValue) 
| extend DeviceDisplayName = tostring(RawEventData.ModifiedProperties[1].NewValue) 
| project DeviceRegistrationTimestamp=Timestamp,ReportId,AccountUpn,AccountObjectId,DeviceObjectId,DeviceDisplayName; 
let registeringUser= 
registeredDevices 
| distinct AccountObjectId; 
let hasRegisteringUser = isnotempty(toscalar(registeringUser));
let riskySignins=AADSignInEventsBeta
| where hasRegisteringUser
| where AccountObjectId in (registeringUser) 
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level. 
| where Application in ("Office 365 Exchange Online", "OfficeHome") 
| where isnotempty(SessionId) 
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn 
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn; 
registeredDevices 
| join riskySignins on AccountObjectId 
| where  DeviceRegistrationTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h 
| project-away AccountObjectId1
```

## Multiple AAD Admin Removals

Looks for multiple users that had their admin role removed by a single user within a certain period. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 7ffb31ee-f164-4613-a9a7-4d04d0dba5d7 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/multipleAADAdminsRemovals.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let removedAccountsThreshold = 1;
let lookback = 12h;
CloudAppEvents
| where Timestamp > ago(lookback)
| where ApplicationId == 11161 // filter relevant events category
| where ActionType in~ ("Remove member from role.", "Remove eligible member from role.")
| project RawEventData
| where RawEventData.Actor !has "MS-PIM"
| mv-expand modifiedPropery = RawEventData.ModifiedProperties
| where isnotempty(modifiedPropery)
| extend propertyName = modifiedPropery.Name
| where propertyName =~ "Role.DisplayName"
| extend roleName = modifiedPropery.OldValue
| where roleName in ("Company Administrator", "Global Administrator") // Add more roles you found interesting here
| where RawEventData.Actor has "User" // Validate the actor of the oepration is a user and not service principal
| extend Actor = tostring(RawEventData.Actor[0].ID), removedUserUpn = tostring(RawEventData.Target[3].ID)
| summarize removedAccounts = dcount(removedUserUpn), make_set(removedUserUpn) by Actor
| where removedAccounts > removedAccountsThreshold
```

## Multiple AAD Admin Removals

Looks for multiple users that had their admin role removed by a single user within a certain period. 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 7ffb31ee-f164-4613-a9a7-4d04d0dba5d7 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/multipleAADAdminsRemovals.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let removedAccountsThreshold = 1;
let lookback = 12h;
CloudAppEvents
| where Timestamp > ago(lookback)
| where ApplicationId == 11161 // filter relevant events category
| where ActionType in~ ("Remove member from role.", "Remove eligible member from role.")
| project RawEventData
| where RawEventData.Actor !has "MS-PIM"
| mv-expand modifiedPropery = RawEventData.ModifiedProperties
| where isnotempty(modifiedPropery)
| extend propertyName = modifiedPropery.Name
| where propertyName =~ "Role.DisplayName"
| extend roleName = modifiedPropery.OldValue
| where roleName in ("Company Administrator", "Global Administrator") // Add more roles you found interesting here
| where RawEventData.Actor has "User" // Validate the actor of the oepration is a user and not service principal
| extend Actor = tostring(RawEventData.Actor[0].ID), removedUserUpn = tostring(RawEventData.Target[3].ID)
| summarize removedAccounts = dcount(removedUserUpn), make_set(removedUserUpn) by Actor
| where removedAccounts > removedAccountsThreshold
```

## scheduled task creation

Original Sigma Rule: https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_schtask_creation.yml.
Questions via Twitter: @janvonkirchheim.

|Name | Value |
| --- | --- |
|Tactic | |
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 34208765-264e-4abe-805b-f645925fbadb |
|DataTypes | DeviceEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/scheduled%20task%20creation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
DeviceEvents 
| where ActionType == "ScheduledTaskCreated"
  and InitiatingProcessAccountSid != "S-1-5-18"

```

## scheduled task creation

Original Sigma Rule: https://github.com/Neo23x0/sigma/blob/master/rules/windows/process_creation/win_susp_schtask_creation.yml.
Questions via Twitter: @janvonkirchheim.

|Name | Value |
| --- | --- |
|Tactic | |
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 34208765-264e-4abe-805b-f645925fbadb |
|DataTypes | DeviceEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/scheduled%20task%20creation.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
DeviceEvents 
| where ActionType == "ScheduledTaskCreated"
  and InitiatingProcessAccountSid != "S-1-5-18"

```

## Create account (1)

User accounts may be created to achieve persistence on a machine.
Read more here: https://attack.mitre.org/wiki/Technique/T1136.
Tags: #CreateAccount.
Query #1: Query for users being created using "net user" command.
"net user" commands are noisy, so needs to be joined with another signal -.
E.g. in this example we look for use of uncommon & undocumented commandline switches (e.g. /ad instead of /add).

|Name | Value |
| --- | --- |
|Tactic | |
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | eba83f84-b844-4fc9-96f4-cb51b0b20c1d |
|DataTypes | DeviceEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Create%20account%20(1).yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Query #2: Query for accounts created on machines onboarded with Sense.
// Create account event is noisy, so we need to join it with some other signal.
// E.g. In this query we look for accounts created which name resembles "administrator".
//      Using account names similar to known common account names is a common way to be evade the human analyst eye.
DeviceEvents
| where ActionType == "UserAccountCreated"
// To look for account names similar to administrator, we'll simply query for the prefix and suffix,
// because these letters matter most to the human perception: https://en.wikipedia.org/wiki/Typoglycemia
// Calculating distance functions is possible but will be much more complicated - 
// and looking for prefix and suffix should work in this case pretty well.
| where AccountName startswith "ad" and AccountName endswith "or" and AccountName !~ "administrator"
// Note: For the UserAccountCreated event we do not know the details of the process / account that was used to create this new account.
| project AccountName, AccountDomain, DeviceName, Timestamp
| limit 100
```

## Create account (1)

User accounts may be created to achieve persistence on a machine.
Read more here: https://attack.mitre.org/wiki/Technique/T1136.
Tags: #CreateAccount.
Query #1: Query for users being created using "net user" command.
"net user" commands are noisy, so needs to be joined with another signal -.
E.g. in this example we look for use of uncommon & undocumented commandline switches (e.g. /ad instead of /add).

|Name | Value |
| --- | --- |
|Tactic | |
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | eba83f84-b844-4fc9-96f4-cb51b0b20c1d |
|DataTypes | DeviceEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Create%20account%20(1).yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql

// Query #2: Query for accounts created on machines onboarded with Sense.
// Create account event is noisy, so we need to join it with some other signal.
// E.g. In this query we look for accounts created which name resembles "administrator".
//      Using account names similar to known common account names is a common way to be evade the human analyst eye.
DeviceEvents
| where ActionType == "UserAccountCreated"
// To look for account names similar to administrator, we'll simply query for the prefix and suffix,
// because these letters matter most to the human perception: https://en.wikipedia.org/wiki/Typoglycemia
// Calculating distance functions is possible but will be much more complicated - 
// and looking for prefix and suffix should work in this case pretty well.
| where AccountName startswith "ad" and AccountName endswith "or" and AccountName !~ "administrator"
// Note: For the UserAccountCreated event we do not know the details of the process / account that was used to create this new account.
| project AccountName, AccountDomain, DeviceName, Timestamp
| limit 100
```

## wadhrama-ransomware

This query was originally published in the threat analytics report, RDP ransomware persists as Wadhrama.
The ransomware known as Wadhrama has been used in human-operated attacks that follow a particular pattern. The attackers often use Remote Desktop Protocol (RDP) to gain initial access to a device or network, exfiltrate credentials, and maintain persistance.
The following query checks for possible Wadhrama-related activity, by searching for attempts to establish RDP persistance via the registry.
Other techniques used by the group associated with Wadhrama are listed under See also.
Reference - https://www.microsoft.com/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/Wadhrama

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 733c3a83-5950-496c-90f0-d66f0efa3c35 |
|DataTypes | DeviceProcessEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/wadhrama-ransomware.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
// Find attempts to establish RDP persistence via the registry
let Allow = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "AllowTSConnections"
| extend AllowReport = Timestamp ;
//
let Deny = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "fDenyTSConnections"
| extend DenyReport = Timestamp;
//
let Special = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "SpecialAccounts"
| extend SpecialReport = Timestamp;
//
Special | join kind=inner (Deny | join kind=inner Allow on DeviceId) on DeviceId
| where AllowReport < Timestamp +10s and AllowReport > Timestamp -10s
| where DenyReport < Timestamp +10s and DenyReport > Timestamp -10s
| where SpecialReport < Timestamp +10s and SpecialReport > Timestamp -10s

```

## wadhrama-ransomware

This query was originally published in the threat analytics report, RDP ransomware persists as Wadhrama.
The ransomware known as Wadhrama has been used in human-operated attacks that follow a particular pattern. The attackers often use Remote Desktop Protocol (RDP) to gain initial access to a device or network, exfiltrate credentials, and maintain persistance.
The following query checks for possible Wadhrama-related activity, by searching for attempts to establish RDP persistance via the registry.
Other techniques used by the group associated with Wadhrama are listed under See also.
Reference - https://www.microsoft.com/wdsi/threats/malware-encyclopedia-description?Name=Ransom:Win32/Wadhrama

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 733c3a83-5950-496c-90f0-d66f0efa3c35 |
|DataTypes | DeviceProcessEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/wadhrama-ransomware.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
// Find attempts to establish RDP persistence via the registry
let Allow = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "AllowTSConnections"
| extend AllowReport = Timestamp ;
//
let Deny = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "fDenyTSConnections"
| extend DenyReport = Timestamp;
//
let Special = DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "reg.exe"
| where ProcessCommandLine has "SpecialAccounts"
| extend SpecialReport = Timestamp;
//
Special | join kind=inner (Deny | join kind=inner Allow on DeviceId) on DeviceId
| where AllowReport < Timestamp +10s and AllowReport > Timestamp -10s
| where DenyReport < Timestamp +10s and DenyReport > Timestamp -10s
| where SpecialReport < Timestamp +10s and SpecialReport > Timestamp -10s

```

## Risky Sign-in with new MFA method

Looks for a new MFA method added to an account that was preceded by medium or high risk sign-in session for the same user within maximum 6h timeframe 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 0f57238b-e764-4246-b101-f78bf8c942a7 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToNewMFAMethod.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let mfaMethodAdded=CloudAppEvents
| where ActionType =~ "Update user." 
| where RawEventData has "StrongAuthenticationPhoneAppDetail"
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.Target[1].ID)
| extend AccountUpn = tostring(RawEventData.ObjectId)
| extend AccountObjectId = tostring(RawEventData.Target[1].ID)
| project MfaAddedTimestamp=Timestamp,AccountUpn,AccountObjectId;
let usersWithNewMFAMethod=mfaMethodAdded
| distinct AccountObjectId;
let hasusersWithNewMFAMethod = isnotempty(toscalar(usersWithNewMFAMethod));
let riskySignins=AADSignInEventsBeta
| where hasusersWithNewMFAMethod
| where AccountObjectId in (usersWithNewMFAMethod)
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level.
| where Application in ("Office 365 Exchange Online", "OfficeHome")
| where isnotempty(SessionId)
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn;
mfaMethodAdded
| join riskySignins on AccountObjectId
| where MfaAddedTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h
| project-away AccountObjectId1
```

## Risky Sign-in with new MFA method

Looks for a new MFA method added to an account that was preceded by medium or high risk sign-in session for the same user within maximum 6h timeframe 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 0f57238b-e764-4246-b101-f78bf8c942a7 |
|DataTypes | CloudAppEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToNewMFAMethod.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let mfaMethodAdded=CloudAppEvents
| where ActionType =~ "Update user." 
| where RawEventData has "StrongAuthenticationPhoneAppDetail"
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.Target[1].ID)
| extend AccountUpn = tostring(RawEventData.ObjectId)
| extend AccountObjectId = tostring(RawEventData.Target[1].ID)
| project MfaAddedTimestamp=Timestamp,AccountUpn,AccountObjectId;
let usersWithNewMFAMethod=mfaMethodAdded
| distinct AccountObjectId;
let hasusersWithNewMFAMethod = isnotempty(toscalar(usersWithNewMFAMethod));
let riskySignins=AADSignInEventsBeta
| where hasusersWithNewMFAMethod
| where AccountObjectId in (usersWithNewMFAMethod)
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level.
| where Application in ("Office 365 Exchange Online", "OfficeHome")
| where isnotempty(SessionId)
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn;
mfaMethodAdded
| join riskySignins on AccountObjectId
| where MfaAddedTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h
| project-away AccountObjectId1
```

## Risky Sign-in with new MFA method

Looks for a new MFA method added to an account that was preceded by medium or high risk sign-in session for the same user within maximum 6h timeframe 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 0f57238b-e764-4246-b101-f78bf8c942a7 |
|DataTypes | AADSignInEventsBeta |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToNewMFAMethod.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let mfaMethodAdded=CloudAppEvents
| where ActionType =~ "Update user." 
| where RawEventData has "StrongAuthenticationPhoneAppDetail"
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.Target[1].ID)
| extend AccountUpn = tostring(RawEventData.ObjectId)
| extend AccountObjectId = tostring(RawEventData.Target[1].ID)
| project MfaAddedTimestamp=Timestamp,AccountUpn,AccountObjectId;
let usersWithNewMFAMethod=mfaMethodAdded
| distinct AccountObjectId;
let hasusersWithNewMFAMethod = isnotempty(toscalar(usersWithNewMFAMethod));
let riskySignins=AADSignInEventsBeta
| where hasusersWithNewMFAMethod
| where AccountObjectId in (usersWithNewMFAMethod)
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level.
| where Application in ("Office 365 Exchange Online", "OfficeHome")
| where isnotempty(SessionId)
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn;
mfaMethodAdded
| join riskySignins on AccountObjectId
| where MfaAddedTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h
| project-away AccountObjectId1
```

## Risky Sign-in with new MFA method

Looks for a new MFA method added to an account that was preceded by medium or high risk sign-in session for the same user within maximum 6h timeframe 

|Name | Value |
| --- | --- |
|Tactic | Persistence|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 0f57238b-e764-4246-b101-f78bf8c942a7 |
|DataTypes | AADSignInEventsBeta |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/riskySignInToNewMFAMethod.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let mfaMethodAdded=CloudAppEvents
| where ActionType =~ "Update user." 
| where RawEventData has "StrongAuthenticationPhoneAppDetail"
| where isnotempty(RawEventData.ObjectId) and isnotempty(RawEventData.Target[1].ID)
| extend AccountUpn = tostring(RawEventData.ObjectId)
| extend AccountObjectId = tostring(RawEventData.Target[1].ID)
| project MfaAddedTimestamp=Timestamp,AccountUpn,AccountObjectId;
let usersWithNewMFAMethod=mfaMethodAdded
| distinct AccountObjectId;
let hasusersWithNewMFAMethod = isnotempty(toscalar(usersWithNewMFAMethod));
let riskySignins=AADSignInEventsBeta
| where hasusersWithNewMFAMethod
| where AccountObjectId in (usersWithNewMFAMethod)
| where RiskLevelDuringSignIn in ("50","100") //Medium and High sign-in risk level.
| where Application in ("Office 365 Exchange Online", "OfficeHome")
| where isnotempty(SessionId)
| project SignInTimestamp=Timestamp, Application, SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn
| summarize SignInTimestamp=argmin(SignInTimestamp,*) by Application,SessionId, AccountObjectId, IPAddress,RiskLevelDuringSignIn;
mfaMethodAdded
| join riskySignins on AccountObjectId
| where MfaAddedTimestamp - SignInTimestamp < 6h //Time delta between risky sign-in and device registration less than 6h
| project-away AccountObjectId1
```

## Possible webshell drop

This query looks for files created by IIS or Apache matching common web page content extensions which
can be used to execute arbitrary code.
The query uses a throtlling mechanism in an attempt to avoid false positive detections for WebDAV or
other web-based content management which might run under the context of the webserver process. Consider
increasing the value of MaxFileOperations based on your false positive detection tolerance, or set it
to -1 to disable this feature.
Additional extensions of interest are listed after ExtensionList. Again, consider including \ excluding
these extensions based on your organization's use and tolerance of potential false positive detections.

|Name | Value |
| --- | --- |
|Tactic | Initial access|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 8f2a256f-c9f1-4f0a-941a-a5a131d4bf3b |
|DataTypes | DeviceFileEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Possible%20webshell%20drop.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let MaxFileOperations = 3; // This will attempt to hide WebDAV publish operations by looking for file operations less than 'x' in a 5 minute period
let MaxAge = ago(7d); // This is how far back the query will search
let ExtensionList = pack_array('asp','aspx','aar','ascx','ashx','asmx','c','cfm','cgi','jsp','jspx','php','pl');//,'exe','dll','js','jar','py','ps1','psm1','cmd','psd1','java','wsf','vbs') Commented ones may cause false positive detection - add at will
let IncludeTemp = false; // whether to include files that contain \temp\ in their path
let PossibleShells = DeviceFileEvents 
| where Timestamp  > MaxAge 
    and InitiatingProcessFileName in~('w3wp.exe','httpd.exe') 
    and (IncludeTemp or FolderPath  !contains @'\temp\')
    and ActionType in ('FileCreated', 'FileRenamed', 'FileModified')
| extend extension = tolower(tostring(split(FileName,'.')[-1]))
    , TimeBin = bin(Timestamp, 5m)
| where extension in (ExtensionList);
PossibleShells
| summarize count() by DeviceId, TimeBin
| where MaxFileOperations == -1 or count_ < MaxFileOperations
| join kind=rightsemi PossibleShells on DeviceId, TimeBin

```

## Possible webshell drop

This query looks for files created by IIS or Apache matching common web page content extensions which
can be used to execute arbitrary code.
The query uses a throtlling mechanism in an attempt to avoid false positive detections for WebDAV or
other web-based content management which might run under the context of the webserver process. Consider
increasing the value of MaxFileOperations based on your false positive detection tolerance, or set it
to -1 to disable this feature.
Additional extensions of interest are listed after ExtensionList. Again, consider including \ excluding
these extensions based on your organization's use and tolerance of potential false positive detections.

|Name | Value |
| --- | --- |
|Tactic | Initial access|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 8f2a256f-c9f1-4f0a-941a-a5a131d4bf3b |
|DataTypes | DeviceFileEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Possible%20webshell%20drop.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let MaxFileOperations = 3; // This will attempt to hide WebDAV publish operations by looking for file operations less than 'x' in a 5 minute period
let MaxAge = ago(7d); // This is how far back the query will search
let ExtensionList = pack_array('asp','aspx','aar','ascx','ashx','asmx','c','cfm','cgi','jsp','jspx','php','pl');//,'exe','dll','js','jar','py','ps1','psm1','cmd','psd1','java','wsf','vbs') Commented ones may cause false positive detection - add at will
let IncludeTemp = false; // whether to include files that contain \temp\ in their path
let PossibleShells = DeviceFileEvents 
| where Timestamp  > MaxAge 
    and InitiatingProcessFileName in~('w3wp.exe','httpd.exe') 
    and (IncludeTemp or FolderPath  !contains @'\temp\')
    and ActionType in ('FileCreated', 'FileRenamed', 'FileModified')
| extend extension = tolower(tostring(split(FileName,'.')[-1]))
    , TimeBin = bin(Timestamp, 5m)
| where extension in (ExtensionList);
PossibleShells
| summarize count() by DeviceId, TimeBin
| where MaxFileOperations == -1 or count_ < MaxFileOperations
| join kind=rightsemi PossibleShells on DeviceId, TimeBin

```

## Possible webshell drop

This query looks for files created by IIS or Apache matching common web page content extensions which
can be used to execute arbitrary code.
The query uses a throtlling mechanism in an attempt to avoid false positive detections for WebDAV or
other web-based content management which might run under the context of the webserver process. Consider
increasing the value of MaxFileOperations based on your false positive detection tolerance, or set it
to -1 to disable this feature.
Additional extensions of interest are listed after ExtensionList. Again, consider including \ excluding
these extensions based on your organization's use and tolerance of potential false positive detections.

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | |
|Platform | Azure|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 8f2a256f-c9f1-4f0a-941a-a5a131d4bf3b |
|DataTypes | DeviceFileEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Possible%20webshell%20drop.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let MaxFileOperations = 3; // This will attempt to hide WebDAV publish operations by looking for file operations less than 'x' in a 5 minute period
let MaxAge = ago(7d); // This is how far back the query will search
let ExtensionList = pack_array('asp','aspx','aar','ascx','ashx','asmx','c','cfm','cgi','jsp','jspx','php','pl');//,'exe','dll','js','jar','py','ps1','psm1','cmd','psd1','java','wsf','vbs') Commented ones may cause false positive detection - add at will
let IncludeTemp = false; // whether to include files that contain \temp\ in their path
let PossibleShells = DeviceFileEvents 
| where Timestamp  > MaxAge 
    and InitiatingProcessFileName in~('w3wp.exe','httpd.exe') 
    and (IncludeTemp or FolderPath  !contains @'\temp\')
    and ActionType in ('FileCreated', 'FileRenamed', 'FileModified')
| extend extension = tolower(tostring(split(FileName,'.')[-1]))
    , TimeBin = bin(Timestamp, 5m)
| where extension in (ExtensionList);
PossibleShells
| summarize count() by DeviceId, TimeBin
| where MaxFileOperations == -1 or count_ < MaxFileOperations
| join kind=rightsemi PossibleShells on DeviceId, TimeBin

```

## Possible webshell drop

This query looks for files created by IIS or Apache matching common web page content extensions which
can be used to execute arbitrary code.
The query uses a throtlling mechanism in an attempt to avoid false positive detections for WebDAV or
other web-based content management which might run under the context of the webserver process. Consider
increasing the value of MaxFileOperations based on your false positive detection tolerance, or set it
to -1 to disable this feature.
Additional extensions of interest are listed after ExtensionList. Again, consider including \ excluding
these extensions based on your organization's use and tolerance of potential false positive detections.

|Name | Value |
| --- | --- |
|Tactic | Execution|
|TechniqueId | |
|Platform | Windows|
|DetectionType | Hunting |
|ConnectorId | MicrosoftThreatProtection |
|DetectionId | 8f2a256f-c9f1-4f0a-941a-a5a131d4bf3b |
|DataTypes | DeviceFileEvents |
|QueryFrequency |  |
|QueryPeriod |  |
|TriggerOperator |  |
|TriggerThreshold |  |
|DetectionSeverity |  |
|DetectionUrl | https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Persistence/Possible%20webshell%20drop.yaml |
|IngestedDate | 2022-08-07 |

### KQL
```kql
let MaxFileOperations = 3; // This will attempt to hide WebDAV publish operations by looking for file operations less than 'x' in a 5 minute period
let MaxAge = ago(7d); // This is how far back the query will search
let ExtensionList = pack_array('asp','aspx','aar','ascx','ashx','asmx','c','cfm','cgi','jsp','jspx','php','pl');//,'exe','dll','js','jar','py','ps1','psm1','cmd','psd1','java','wsf','vbs') Commented ones may cause false positive detection - add at will
let IncludeTemp = false; // whether to include files that contain \temp\ in their path
let PossibleShells = DeviceFileEvents 
| where Timestamp  > MaxAge 
    and InitiatingProcessFileName in~('w3wp.exe','httpd.exe') 
    and (IncludeTemp or FolderPath  !contains @'\temp\')
    and ActionType in ('FileCreated', 'FileRenamed', 'FileModified')
| extend extension = tolower(tostring(split(FileName,'.')[-1]))
    , TimeBin = bin(Timestamp, 5m)
| where extension in (ExtensionList);
PossibleShells
| summarize count() by DeviceId, TimeBin
| where MaxFileOperations == -1 or count_ < MaxFileOperations
| join kind=rightsemi PossibleShells on DeviceId, TimeBin

```
